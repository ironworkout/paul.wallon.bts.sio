<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-P">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ligue des Champions des Peluches - Road to Glory!</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Oswald:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Nouvelle Palette LDC */
            --ldc-deep-blue: #061029;
            --ldc-mid-blue: #0b215c;
            --ldc-light-blue: #00aeff;
            --ldc-purple: #4f0a70;
            --ldc-gold: #FFD700; /* Or classique LDC */
            --ldc-silver: #C0C0C0; /* Argent pour textes secondaires */
            --ldc-text-light: #f0f0f8; /* Texte clair sur fond LDC */
            --ldc-card-bg: rgba(0, 20, 60, 0.3); /* Fond de carte translucide bleut√© */
            --ldc-border-color: rgba(0, 174, 255, 0.4); /* Bordure cyan translucide */
            --ldc-border-color-subtle: rgba(0, 174, 255, 0.2); /* Bordure plus discr√®te */

            /* Couleurs originales conserv√©es pour d'autres sections si besoin, mais LDC utilisera les siennes */
            --bg-color-original: #0f0c29; 
            --primary-color-original: #5352ed; 
            --secondary-color-original: #00c6ff; 
            --accent-gold-original: #ffde59;
            --text-color-light-original: #e0e0fc;
            --text-color-dark-original: #333;
            --card-bg-original: rgba(255, 255, 255, 0.05);
            --border-color-original: rgba(0, 198, 255, 0.3);
            --line-color-original: var(--secondary-color-original);

            --neon-green: #39FF14; 
            --neon-red: #FF3131; 
            --neon-yellow: #FFF01F;

            /* Variables sp√©cifiques LDC pour faciliter la lecture */
            --current-bg-color: var(--ldc-deep-blue);
            --current-primary-color: var(--ldc-mid-blue);
            --current-secondary-color: var(--ldc-light-blue);
            --current-accent-gold: var(--ldc-gold);
            --current-text-light: var(--ldc-text-light);
            --current-card-bg: var(--ldc-card-bg);
            --current-border-color: var(--ldc-border-color);
            --current-line-color: var(--ldc-light-blue);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Open Sans', sans-serif; line-height: 1.6; color: var(--current-text-light);
            background: linear-gradient(145deg, var(--ldc-deep-blue) 0%, var(--ldc-mid-blue) 50%, var(--ldc-purple) 100%);
            overflow-x: hidden; scroll-behavior: smooth;
        }
        .container { width: 100%; max-width: 1400px; margin: 0 auto; padding: 0 20px; }

        h1, h2, h3, h4, .section-title {
            font-family: 'Oswald', sans-serif; font-weight: 700;
            color: var(--current-accent-gold); text-transform: uppercase; letter-spacing: 1px;
            text-shadow: 0 0 8px rgba(255,215,0,0.6); /* Ombre port√©e dor√©e plus prononc√©e */
        }
        
        header {
            background-color: rgba(6, 16, 41, 0.7); /* Fond header accord√© √† --ldc-deep-blue avec transparence */
            backdrop-filter: blur(8px);
            color: var(--current-text-light);
            padding: 10px 0; position: sticky; top: 0; z-index: 1000;
            border-bottom: 1px solid var(--current-border-color);
        }
        .header-container { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; text-decoration: none; color: var(--current-text-light); }
        .logo img { height: 45px; margin-right: 12px; filter: drop-shadow(0 0 8px var(--current-accent-gold));} 
        .logo h1 { font-size: 1.6rem; color: var(--current-accent-gold); letter-spacing: 1px;}
        
        .header-actions { display: flex; align-items: center; gap: 10px; flex-wrap: nowrap; }
         #drive-status { 
            display: inline-flex; align-items: center; gap: 5px; font-size: 0.85em; 
            color: var(--current-text-light); opacity: 0.9; 
            border: 1px solid var(--current-secondary-color); padding: 4px 8px; border-radius: 4px;
            transition: color 0.3s ease, border-color 0.3s ease; white-space: nowrap;
         }
         #drive-status i { margin-right: 5px; color: var(--current-secondary-color); }
         #drive-status.loading { color: var(--neon-yellow); border-color: var(--neon-yellow); }
         #drive-status.success { color: var(--neon-green); border-color: var(--neon-green); }
         #drive-status.error { color: var(--neon-red); border-color: var(--neon-red); }
         #signin-button { 
            padding: 7px 12px; font-size: 0.85em; background-color: var(--current-accent-gold); 
            color: var(--ldc-deep-blue); border: none; border-radius: 4px; cursor: pointer;
            transition: all 0.3s ease; font-weight: 600; white-space: nowrap;
         }
         #signin-button:hover:not(:disabled) { background-color: #fff; transform: translateY(-1px); }
         #signin-button:disabled { opacity: 0.5; cursor: not-allowed; }

        nav { flex-grow: 1; display: flex; justify-content: center; } 
        nav ul { display: flex; list-style: none; margin:0; padding:0; flex-wrap: wrap; justify-content: center;}
        nav ul li { margin: 0 5px; } 
        nav ul li a { 
            color: var(--current-text-light); text-decoration: none; font-weight: 500;
            transition: all 0.3s ease; padding: 10px 15px; 
            display: inline-flex; align-items: center; gap: 8px;
            border-radius: 25px; border: 2px solid transparent;
            font-family: 'Oswald', sans-serif; text-transform: uppercase; font-size:0.9rem; letter-spacing: 0.5px;
        }
        nav ul li a i { font-size: 0.9em; }
        nav ul li a:hover, nav ul li a.active-nav-link {
            color: var(--current-accent-gold); background-color: rgba(0, 174, 255, 0.15); /* Utilisation de ldc-light-blue pour hover */
            border-color: var(--current-secondary-color);
            box-shadow: 0 0 10px rgba(0, 174, 255, 0.5); 
        }
        .hamburger { display: none; font-size: 1.8rem; color: var(--current-text-light); cursor: pointer; z-index: 1001; margin-left:15px;}

        .page-title-bar {
            background: linear-gradient(135deg, var(--ldc-mid-blue) 0%, var(--ldc-purple) 100%); /* D√©grad√© titre LDC */
            color: var(--current-accent-gold); padding: 30px 0; text-align: center; margin-bottom: 40px;
            border-bottom: 6px solid var(--current-accent-gold); box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .page-title-bar h1 {
            font-size: 3.5rem; text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
            color: var(--current-accent-gold); letter-spacing: 2px;
        }
        .page-title-bar h1 i { margin: 0 15px; animation: subtleTrophyPulse 2s infinite ease-in-out; }
        @keyframes subtleTrophyPulse { 0%, 100% {transform: scale(1);} 50% {transform: scale(1.1);} }

        .section { margin-bottom: 50px; background-color: var(--current-card-bg); border-radius: 12px; padding: 30px; box-shadow: 0 6px 25px rgba(0,0,0,0.4); border: 1px solid var(--current-border-color);}
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid var(--current-border-color-subtle); }
        .section-title { font-size: 2.2rem; letter-spacing: 1px; color: var(--current-accent-gold);}
        
        .action-buttons { display:flex; align-items:center; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;}
        .action-buttons .league-music-btn {
            background-color: var(--current-accent-gold); color: var(--ldc-deep-blue); border: 1px solid var(--ldc-deep-blue);
            padding: 10px 18px; border-radius: 25px; font-family: 'Oswald', sans-serif;
            cursor: pointer; transition: all 0.3s ease; font-weight: 600;
        }
        .action-buttons .league-music-btn:hover { background-color: var(--ldc-deep-blue); color: var(--current-accent-gold); border-color: var(--current-accent-gold);}
        .action-buttons .league-music-btn i { margin-right: 8px; }

        .season-selector-container { display: flex; align-items: center; gap: 10px; }
        .season-selector-container label { font-weight: 600; color: var(--current-text-light); font-family: 'Oswald'; }
        .season-selector-container select {
            padding: 8px 12px; border-radius: 4px; border: 1px solid var(--current-border-color);
            font-family: 'Open Sans'; font-size: 0.9rem; background-color: rgba(0, 16, 41, 0.5); color:var(--current-text-light);
        }
        .season-selector-container select option { background-color: var(--ldc-deep-blue); color: var(--current-text-light); }

        .nouvelle-saison-btn, .sauvegarde-json-btn, .delete-season-btn {
            padding: 10px 20px; font-size: 1rem; font-family: 'Oswald', sans-serif; text-transform: uppercase;
            color: var(--ldc-deep-blue); background-color: var(--current-secondary-color); /* Bleu clair LDC */
            border: none; border-radius: 5px; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: all 0.3s ease;
        }
        .nouvelle-saison-btn:hover:not(:disabled), .sauvegarde-json-btn:hover:not(:disabled), .delete-season-btn:hover:not(:disabled) { 
            transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
        }
        .nouvelle-saison-btn:hover:not(:disabled) { background-color: var(--ldc-mid-blue); color: var(--current-text-light); }
        .nouvelle-saison-btn:disabled, .sauvegarde-json-btn:disabled, .delete-season-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .sauvegarde-json-btn { background-color: var(--current-accent-gold); color: var(--ldc-deep-blue); }
        .sauvegarde-json-btn:hover:not(:disabled) { background-color: #fff; color:var(--current-accent-gold); border: 1px solid var(--current-accent-gold); }
        .delete-season-btn { background-color: var(--neon-red); margin-left: 5px; color: #fff;}
        .delete-season-btn:hover:not(:disabled) { background-color: #cc2828; }

        /* Styles pour les tableaux de matchs LDC (phase √† √©limination directe) */
        .knockout-stage { /* Conteneur pour chaque √©tape: Huiti√®mes, Quarts, etc. */
            margin-bottom: 35px;
            padding: 20px;
            background-color: rgba(0,0,0,0.15); /* Un fond l√©g√®rement diff√©rent pour chaque √©tape */
            border-radius: 10px;
            border: 1px solid var(--ldc-border-color-subtle);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .knockout-stage h3 { /* Titre de l'√©tape: Huiti√®mes, Quarts etc. */
            color: var(--current-accent-gold);
            text-align: center;
            margin-bottom: 25px;
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-size: 1.6rem; /* Taille augment√©e */
            padding-bottom: 10px;
            border-bottom: 2px solid var(--ldc-purple); /* Ligne de s√©paration violette */
        }

        .fixtures-table.ldc-fixtures {
            width: 100%;
            border-collapse: collapse;
        }

        .fixtures-table.ldc-fixtures td {
            padding: 12px 8px; 
            border-bottom: 1px solid var(--ldc-border-color-subtle);
        }
        .fixtures-table.ldc-fixtures tr:last-child td {
            border-bottom: none;
        }

        .fixture-match {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .fixture-team {
            display: flex;
            align-items: center;
            flex-basis: calc(50% - 40px); /* Espace pour le nom et logo, laissant de la place pour les scores */
            font-size: 0.95rem; /* L√©g√®rement plus grand */
            color: var(--current-text-light);
        }
        .fixture-team.home {
            justify-content: flex-start;
        }
        .fixture-team.away {
            justify-content: flex-end; 
            text-align: right;
        }
        .fixture-team span { /* Nom de l'√©quipe */
            margin: 0 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Pour les noms longs */
        }

        .fixture-team .team-logo {
            width: 28px;
            height: 28px;
            object-fit: contain;
            border-radius: 50%; /* Logos ronds */
            background-color: rgba(255, 255, 255, 0.05); /* Fond clair pour logos transparents */
            padding: 2px;
            border: 1px solid var(--ldc-border-color-subtle);
            flex-shrink: 0; /* Emp√™che le logo de r√©tr√©cir */
        }
        
        /* Ordre HTML: Domicile: Nom puis Logo ; Ext√©rieur: Logo puis Nom */
        .fixture-team.home .team-logo { order: 1; } 
        .fixture-team.home span { order: 0; }

        .fixture-team.away .team-logo { order: 0; } 
        .fixture-team.away span { order: 1; }


        .fixture-score-inputs {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-basis: 80px; /* Espace fixe pour les scores */
            flex-shrink: 0;
        }
        .fixture-score-inputs input[type="number"] {
            width: 35px; 
            padding: 6px 4px;
            text-align: center;
            background-color: rgba(0,0,0, 0.4); 
            border: 1px solid var(--ldc-border-color);
            color: var(--current-text-light);
            border-radius: 4px;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9rem;
            -moz-appearance: textfield; 
        }
        .fixture-score-inputs input[type="number"]::-webkit-outer-spin-button,
        .fixture-score-inputs input[type="number"]::-webkit-inner-spin-button {
          -webkit-appearance: none; 
          margin: 0;
        }
        .fixture-score-inputs .vs-separator {
            margin: 0 6px;
            font-weight: bold;
            color: var(--current-accent-gold);
            font-size: 0.9rem;
        }
        
        /* Styles pour l'ancien bracket (conserv√©s pour le moment) */
        .knockout-bracket { display: flex; justify-content: space-between; align-items: flex-start; padding: 20px; overflow-x: auto; min-width: 1200px; }
        .round { display: flex; flex-direction: column; justify-content: space-around; align-items: center; margin: 0 10px; min-height: 450px; }
        .round-title { font-family: 'Oswald', sans-serif; color: var(--current-accent-gold); font-size: 1.3em; margin-bottom: 20px; writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); }
        .match {
            background-color: rgba(255, 255, 255, 0.08); border: 1px solid var(--current-border-color);
            border-radius: 8px; padding: 10px; margin-bottom: 20px; width: 200px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); position: relative;
        }
        .match-teams { display: flex; flex-direction: column; gap: 5px; }
        .match-team { display: flex; align-items: center; justify-content: space-between; padding: 5px 0; font-size: 0.9em;}
        .match-team .team-name { flex-grow: 1; text-align: left; padding-left: 5px; }
        .match-team .team-logo { width: 24px; height: 24px; margin-right: 8px; } /* Ce style peut √™tre surcharg√© par le nouveau ci-dessus pour .fixture-team .team-logo */
        .match-team input[type="number"] {
            width: 35px; padding: 3px; text-align: center; margin-left: 8px;
            background-color: rgba(255,255,255,0.1); border: 1px solid var(--current-border-color); color: var(--current-text-light);
            border-radius: 3px; font-family: 'Roboto Mono', monospace;
        }
         .match-connector-h, .match-connector-v { position: absolute; background-color: var(--current-line-color); z-index: -1; }
        .match-connector-h { height: 2px; }
        .match-connector-v { width: 2px; }
        .round.round-of-16 .match { margin-bottom: 40px; } 
        .round.quarter-finals .match { margin-bottom: 80px; }
        .round.semi-finals .match { margin-bottom: 160px; }
        .round.final .match { align-self: center; margin-top: calc(50% - 100px); }
        
        .bracket-center-piece { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0 40px; }
        #ldc-trophy-img { width: 120px; height: auto; filter: drop-shadow(0 0 15px var(--current-accent-gold)); margin: 20px 0; }
        #ldc-winner-section { 
            background: none; border: 2px solid var(--current-accent-gold); box-shadow: 0 0 20px var(--current-accent-gold);
            color: var(--current-accent-gold); padding: 20px; border-radius: 10px;
            text-align:center; margin-top: 20px; display:none; 
        }
        #ldc-winner-section .section-title { color: var(--current-accent-gold); }
        #ldc-winner-display { font-size: 2rem; font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 1px; font-weight:700; margin-top: 10px; }
        #ldc-winner-display .team-logo { width: 40px; height: 40px; vertical-align: middle; margin-right: 10px;}


        .teams-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; } 
        .team-card { 
            background-color: var(--current-card-bg); 
            border: 1px solid var(--current-border-color-subtle); 
            border-radius: 10px; padding: 15px; text-align: center; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: all 0.3s ease; 
        }
        .team-card:hover { transform: translateY(-6px) scale(1.02); box-shadow: 0 10px 25px rgba(0,0,0,0.3); border-color: var(--current-border-color); }
        .team-card img { width: 60px; height: 60px; object-fit: contain; margin-bottom: 10px; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));}
        .team-card h4 { font-size: 1.1rem; margin-bottom: 5px; color: var(--current-text-light); }

        footer { 
            background-color: var(--ldc-deep-blue); /* Fond footer accord√© */
            color: var(--ldc-silver); /* Texte footer plus doux */
            padding: 50px 0 30px; 
            border-top: 5px solid var(--ldc-mid-blue); /* Bordure sup√©rieure accord√©e */
        }
        .footer-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 30px; }
        .footer-section h3 { font-size: 1.2rem; margin-bottom: 20px; color: var(--current-accent-gold); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--current-accent-gold); padding-bottom: 10px; display: inline-block;}
        .footer-section ul { list-style: none; padding: 0;}
        .footer-section ul li { margin-bottom: 10px; }
        .footer-section ul li a { color: var(--ldc-silver); text-decoration: none; transition: color 0.3s ease, padding-left 0.3s ease; display: block; }
        .footer-section ul li a:hover { color: var(--current-accent-gold); padding-left: 5px; }
        .copyright { text-align: center; margin-top: 40px; padding-top: 30px; border-top: 1px solid var(--ldc-mid-blue); font-size: 0.9rem; color: var(--ldc-silver); opacity: 0.8; }
        
        .message-area {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            background-color: rgba(11, 33, 92, 0.9); /* Fond message accord√© √† --ldc-mid-blue */
            color: var(--current-text-light);
            padding: 12px 25px; border-radius: 6px; z-index: 3000; 
            opacity: 0; visibility: hidden; transition: all 0.5s ease; pointer-events: none;
            font-size: 0.95em; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            max-width: 90%; text-align: center; 
            border: 1px solid var(--ldc-light-blue);
        }
        .message-area.visible { opacity: 1; visibility: visible; transform: translate(-50%, -15px) ; pointer-events: auto; }
        .message-area.error-message { background-color: rgba(var(--neon-red-rgb, 255, 49, 49), 0.8); border: 1px solid var(--neon-red); text-shadow: 0 0 3px black;}


        @media (max-width: 1200px) { 
            .knockout-bracket { padding: 10px; min-width: 900px; }
            .round { margin: 0 5px; }
            .match { width: 180px; padding: 8px; }
            .round.round-of-16 .match { margin-bottom: 20px; } 
            .round.quarter-finals .match { margin-bottom: 50px; }
            .round.semi-finals .match { margin-bottom: 100px; }
        }
        @media (max-width: 992px) {
            .header-container { flex-wrap: wrap; }
            .header-actions { order: 3; width: 100%; justify-content: center; margin-top:10px; }
            nav {order:1; flex-grow: 0; margin-right: auto;} 
            .hamburger {display: block; order: 2; margin-left: 15px;}
            nav.active { max-height: 500px; } /* Nav d√©pli√©e */
            nav ul { flex-direction: column; padding: 10px 0; gap: 0; background-color: rgba(6, 16, 41, 0.95); /* Fond nav mobile */ }
            nav ul li { margin-left: 0; width: 100%; }
            nav ul li a { padding: 15px 20px; border-bottom: 1px solid var(--ldc-border-color-subtle); border-radius:0; justify-content: flex-start; }
            nav ul li a:hover, nav ul li a.active-nav-link { background-color: rgba(0, 174, 255, 0.2); border-color:transparent; color: var(--current-accent-gold); transform: none; box-shadow: none;}
            .teams-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); } /* Cartes √©quipes un peu plus petites */

            .fixture-team { flex-basis: calc(50% - 35px); font-size: 0.9rem; }
            .fixture-team span { margin: 0 6px;}
            .fixture-score-inputs { flex-basis: 70px; }
            .fixture-score-inputs input[type="number"] { width: 30px; padding: 5px 3px; font-size: 0.85rem;}
            .fixture-score-inputs .vs-separator { margin: 0 4px; font-size: 0.85rem;}
        }
        @media (max-width: 768px) {
            .logo h1 { font-size: 1.5rem; }
            .page-title-bar h1 {font-size: 2.2rem;}
            .section-title { font-size: 1.8rem; }
            .knockout-stage h3 { font-size: 1.4rem; } /* Titre des √©tapes plus petit */
            .fixtures-table.ldc-fixtures td { padding: 10px 5px;}
            .fixture-match { flex-wrap: wrap; justify-content: center; /* Permet le retour √† la ligne si besoin */ }
            .fixture-team { flex-basis: 100%; margin-bottom: 5px; /* Chaque √©quipe prend toute la largeur */ }
            .fixture-team.home { justify-content: space-between; flex-direction: row-reverse; /* Logo √† gauche, nom √† droite */}
            .fixture-team.away { justify-content: space-between; /* Logo √† gauche, nom √† droite */}
            .fixture-team span { text-align: center; flex-grow:1; }
            .fixture-score-inputs { flex-basis: 100%; margin-top: 8px; }


            .action-buttons { flex-direction: column; align-items: stretch;}
            .season-selector-container { flex-direction: column; align-items: stretch; width: 100%;}
            .season-selector-container select { width: 100%; margin-bottom: 10px;}
             .knockout-bracket { flex-direction: column; align-items: center; min-width: unset;}
             .round { margin: 20px 0; min-height: unset; flex-direction: row; flex-wrap:wrap; justify-content:center;}
             .round-title { writing-mode: horizontal-tb; transform: none; margin-bottom:10px; width:100%; text-align:center;}
             .match { width: clamp(280px, 90%, 350px); margin: 10px;}
        }
        @media (max-width: 576px) {
            .logo h1 { font-size: 1.3rem; }
            nav ul li a {font-size: 0.9rem; padding: 10px 15px;} 
            .page-title-bar h1 {font-size: 1.8rem;}
            .section { padding: 20px; }
            .section-title { font-size: 1.6rem; }
            .knockout-stage h3 { font-size: 1.3rem; }
            .nouvelle-saison-btn, .sauvegarde-json-btn, .delete-season-btn { padding: 10px 15px; font-size: 0.9rem;}
            .fixture-team { font-size: 0.85rem; }
            .fixture-team .team-logo { width: 24px; height: 24px; }
            .fixture-score-inputs input[type="number"] { width: 30px; font-size: 0.8rem; }
            
            .footer-container { grid-template-columns: 1fr; text-align: center; }
            .footer-section h3 { display: block; border-bottom: none; padding-bottom: 5px; margin-bottom: 10px; }
            .footer-section h3::after { content:""; display:block; width:50px; height:1px; background:var(--current-accent-gold); margin: 5px auto 0; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-container">
            <a href="index.html" class="logo"> 
                <img src="https://ironworkout.github.io/paul.wallon.bts.sio/OIP.png" alt="Logo Championnat Peluches √âlite">
                <h1>Peluche √âlite</h1>
            </a>
            <nav>
                <ul>
                    <li><a href="index.html"><i class="fas fa-shield-alt"></i> Ligues Nat.</a></li>
                    <li><a href="champions.html" class="active-nav-link"><i class="fas fa-trophy"></i> LDC</a></li> 
                    <li><a href="index.html#actualites-section-container"><i class="fas fa-newspaper"></i> Actualit√©s</a></li>
                </ul>
            </nav>
            <div class="header-actions">
                 <div id="drive-status" style="display: none;"> 
                    <i class="fab fa-google-drive"></i> <span id="drive-status-text">D√©connect√©</span>
                 </div>
                <button id="signin-button" disabled><i class="fab fa-google"></i> Drive</button>
            </div>
            <div class="hamburger"><i class="fas fa-bars"></i></div>
        </div>
    </header>

    <div class="page-title-bar">
        <div class="container">
            <h1><i class="fas fa-trophy"></i> Ligue des Champions des Peluches <i class="fas fa-star"></i></h1>
        </div>
    </div>

    <div class="tab-content active" id="ldc-content">
        <div class="container ldc-theme">
             <div class="section action-buttons">
                <button class="league-music-btn" id="ldc-music-btn" data-league-audio="ldc" aria-label="Jouer/Mettre en pause l'hymne de la LDC">
                    <i class="fas fa-play"></i> Hymne LDC
                </button>
            </div>
             <div class="section action-buttons">
                 <div class="season-selector-container">
                     <label for="ldc-season-selector">Saison LDC :</label>
                     <select id="ldc-season-selector" data-league="ldc"></select>
                     <button class="delete-season-btn" id="delete-season-ldc-btn" title="Supprimer la saison LDC s√©lectionn√©e" disabled><i class="fas fa-trash-alt"></i></button>
                 </div>
                 <button class="nouvelle-saison-btn" id="nouvelle-saison-ldc-btn" disabled><i class="fas fa-plus-circle"></i> Nouvelle Saison LDC</button>
                 <button class="sauvegarde-json-btn" id="sauvegarde-ldc-btn" disabled><i class="fas fa-save"></i> Sauvegarder LDC</button>
            </div>

            <div class="section" id="ldc-teams-section">
                <div class="section-header"><h2 class="section-title">√âquipes Qualifi√©es</h2></div>
                <div class="section-content"><div class="teams-grid" id="ldc-teams-grid"></div></div>
            </div>

            <div class="section" id="ldc-fixtures-section">
                <div class="section-header"><h2 class="section-title">Phase √† √âlimination Directe</h2></div>
                <!-- Le contenu des matchs (knockout stages) sera g√©n√©r√© ici par JavaScript -->
                <div id="ldc-knockout-stages"> 
                    <!-- Exemple de structure attendue (sera remplac√©e par JS) :
                    <div class="knockout-stage">
                        <h3>Huiti√®mes de Finale</h3>
                        <table class="fixtures-table ldc-fixtures">
                            <tbody>
                                <tr> (match) </tr>
                            </tbody>
                        </table>
                    </div>
                    -->
                </div>
            </div>
            
            <div class="section" id="ldc-winner-section" style="text-align: center; display:none;">
                 <h2 class="section-title">üèÜ CHAMPION LDC üèÜ</h2>
                 <div id="ldc-winner-display" style="font-size: 2.5rem; color: var(--current-accent-gold); margin-top: 20px;">
                 </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container footer-container">
            <div class="footer-section"><h3>Navigation</h3><ul><li><a href="index.html">Accueil Championnats</a></li><li><a href="champions.html">Ligue des Champions</a></li><li><a href="index.html#actualites-section-container">Actualit√©s</a></li></ul></div>
            <div class="footer-section"><h3>Contact</h3><ul><li><a href="mailto:contact@peluche-elite.com">Email</a></li><li><a href="#">FAQ</a></li></ul></div>
        </div>
        <div class="copyright">¬© 2025 Championnat Peluche √âlite. Tous droits r√©serv√©s.</div>
    </footer>

    <div id="message-area" class="message-area" role="status" aria-live="polite"></div>

    <audio id="ldc-audio-player" src="https://ironworkout.github.io/paul.wallon.bts.sio/ldc.mp3" loop preload="auto"></audio>

    <script>
        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const LDC_DATA_FILENAME = 'peluches_ldc_data.json'; 
        const BASE_URL = "https://ironworkout.github.io/paul.wallon.bts.sio/";
        const GIS_CHECK_INTERVAL = 100; 
        const GIS_MAX_RETRIES = 50; 

        const initialLdcData = {
            teams: { 
                "PSG Peluches": { "logo": "psg.png" }, "Olympique Ours": { "logo": "oo.png" },
                "Valenciennes FC": { "logo": "vafc.png" }, "Toulours FC": { "logo": "tfc.png" },
                "Peluche FC": { "logo": "pfc.png"}, "AS Carrotes": {"logo": "ascl.png"},
                "AS Saint-Ettours": { "logo": "asset.png"}, "Patapouf FC": { "logo": "patapouf.png"} ,
                "DreamTeam Fluffies": { "logo": "pfc.png" }, "Galactic Teddies": { "logo": "oo.png"},
                "United Plushies": { "logo": "tfc.png" }, "Cotton Ballers FC": { "logo": "vafc.png"},
                "The Snuggle Squad": { "logo": "ascl.png" }, "Wooly Wanderers": { "logo": "asset.png"},
                "Fuzzy Strikers": { "logo": "patapouf.png" }, "Velvet Victory": { "logo": "psg.png"}
            },
            seasons: [], active_season_id: null, fileId: null, filename: LDC_DATA_FILENAME
        };
        
        let ldcDataStore = JSON.parse(JSON.stringify(initialLdcData));

        let googleAccessToken = null, tokenClient = null;
        let isSavingDriveData = false; 
        let messageArea = null;
        let messageTimeoutId = null;
        let gisCheckRetries = 0;
        let audioContext = null;
        let ldcAudioPlayer = null;

        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
        
        function showMessage(msg, duration = 3000, isError = false) {
            if (!messageArea) messageArea = document.getElementById('message-area');
            if (!messageArea) return;
            messageArea.textContent = msg;
            messageArea.classList.add('visible');
            if(isError) messageArea.classList.add('error-message'); else messageArea.classList.remove('error-message');
            clearTimeout(messageTimeoutId);
            messageTimeoutId = setTimeout(() => { messageArea.classList.remove('visible'); }, duration);
        }

        function initAudioContext() {
            if (audioContext) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) { console.warn("Web Audio API non support√©e.", e); }
        }

        async function gisInitInternal() {
            console.log("Tentative d'initialisation de Google Identity Services...");
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                console.log("GIS pr√™t. Initialisation du client token.");
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: GOOGLE_DRIVE_SCOPES,
                    callback: tokenCallback,
                    error_callback: handleTokenError
                });
                updateAuthUI(false); // Suppose d√©connect√© au d√©but
                document.getElementById('signin-button').disabled = false;
                document.getElementById('drive-status').style.display = 'inline-flex';
            } else {
                console.log("GIS non encore pr√™t. Nouvelle tentative...");
                gisCheckRetries++;
                if (gisCheckRetries < GIS_MAX_RETRIES) {
                    setTimeout(gisInitInternal, GIS_CHECK_INTERVAL);
                } else {
                    console.error("√âchec du chargement de Google Identity Services apr√®s plusieurs tentatives.");
                    showMessage("Erreur: Service Google indisponible.", 5000, true);
                    updateAuthUI(false);
                    document.getElementById('drive-status').innerHTML += ' (Erreur GIS)';
                    document.getElementById('drive-status').classList.add('error');
                }
            }
        }

        function checkAndInitGis() {
            if (window.google && window.google.accounts && window.google.accounts.id) {
                gisInitInternal();
            } else {
                const script = document.createElement('script');
                script.src = 'https://accounts.google.com/gsi/client';
                script.async = true;
                script.defer = true;
                script.onload = gisInitInternal;
                script.onerror = () => {
                    console.error("√âchec du chargement du script GSI.");
                    showMessage("Impossible de charger les services Google.", 5000, true);
                     document.getElementById('drive-status').style.display = 'inline-flex';
                     document.getElementById('drive-status').innerHTML += ' (√âchec chargement)';
                     document.getElementById('drive-status').classList.add('error');
                };
                document.head.appendChild(script);
            }
        }
        
        function handleTokenError(error) {
            console.error('Erreur de token:', error);
            showMessage(`Erreur d'authentification Google: ${error.message || error.details || 'Erreur inconnue'}`, 5000, true);
            googleAccessToken = null;
            updateAuthUI(false);
        }

        async function tokenCallback(tokenResponse) {
            if (tokenResponse && tokenResponse.access_token) {
                console.log("Token re√ßu.");
                googleAccessToken = tokenResponse.access_token;
                localStorage.setItem('google_access_token_ldc', googleAccessToken);
                updateAuthUI(true);
                await loadLdcDataFromDrive();
                populateLdcUI(); // Actualise l'UI avec les donn√©es charg√©es ou initiales
                document.getElementById('nouvelle-saison-ldc-btn').disabled = false;
                document.getElementById('sauvegarde-ldc-btn').disabled = false;
                document.getElementById('delete-season-ldc-btn').disabled = !(ldcDataStore.seasons && ldcDataStore.seasons.length > 1);


            } else {
                console.error("R√©ponse de token invalide:", tokenResponse);
                let errorMsg = "Erreur d'authentification Google.";
                if (tokenResponse && tokenResponse.error) { errorMsg += ` (${tokenResponse.error})` }
                showMessage(errorMsg, 5000, true);
                googleAccessToken = null;
                updateAuthUI(false);
            }
        }

        function handleAuthClick() {
            if (googleAccessToken) { // D√©connexion
                google.accounts.oauth2.revoke(googleAccessToken, () => {
                    console.log('Token r√©voqu√©.');
                });
                googleAccessToken = null;
                localStorage.removeItem('google_access_token_ldc');
                updateAuthUI(false);
                ldcDataStore = JSON.parse(JSON.stringify(initialLdcData)); // R√©initialiser aux donn√©es par d√©faut
                populateLdcUI();
                showMessage("D√©connect√© de Google Drive.", 3000);
                document.getElementById('nouvelle-saison-ldc-btn').disabled = true;
                document.getElementById('sauvegarde-ldc-btn').disabled = true;
                document.getElementById('delete-season-ldc-btn').disabled = true;
            } else { // Connexion
                if (tokenClient) {
                    tokenClient.requestAccessToken({ prompt: 'consent' });
                } else {
                    console.error("Client Token non initialis√©.");
                    showMessage("Erreur d'initialisation Google. Veuillez r√©essayer.", 4000, true);
                }
            }
        }
        
        function updateAuthUI(isLoggedIn) {
            const signinButton = document.getElementById('signin-button');
            const driveStatusText = document.getElementById('drive-status-text');
            const driveStatusDiv = document.getElementById('drive-status');

            if (!signinButton || !driveStatusText || !driveStatusDiv) return;

            if (isLoggedIn) {
                signinButton.innerHTML = '<i class="fab fa-google-drive"></i> D√©connexion Drive';
                driveStatusText.textContent = 'Connect√©';
                driveStatusDiv.classList.remove('error', 'loading');
                driveStatusDiv.classList.add('success');
                document.getElementById('nouvelle-saison-ldc-btn').disabled = false;
                document.getElementById('sauvegarde-ldc-btn').disabled = false;
                document.getElementById('delete-season-ldc-btn').disabled = !(ldcDataStore.seasons && ldcDataStore.seasons.length > 1);

            } else {
                signinButton.innerHTML = '<i class="fab fa-google"></i> Connexion Drive';
                driveStatusText.textContent = 'D√©connect√©';
                driveStatusDiv.classList.remove('success', 'loading');
                driveStatusDiv.classList.add('error'); // Ou une classe neutre
                document.getElementById('nouvelle-saison-ldc-btn').disabled = true;
                document.getElementById('sauvegarde-ldc-btn').disabled = true;
                document.getElementById('delete-season-ldc-btn').disabled = true;
            }
            signinButton.disabled = !tokenClient; // D√©sactiver si le client n'est pas pr√™t
        }

        async function findOrCreateFile(filename, defaultContentStr = "{}", mimeType = 'application/json') {
             if (!googleAccessToken) return null;
             const driveStatusText = document.getElementById('drive-status-text');
             if(driveStatusText) driveStatusText.textContent = "Recherche fichier...";
             driveStatusText.parentElement.classList.add('loading');

            try {
                const responseSearch = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${filename}'&spaces=drive&fields=files(id,name)`, {
                    headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                });
                if (!responseSearch.ok) throw new Error(`Recherche √©chou√©e: ${responseSearch.status}`);
                const searchResult = await responseSearch.json();

                if (searchResult.files && searchResult.files.length > 0) {
                    if(driveStatusText) driveStatusText.textContent = "Fichier trouv√©.";
                    driveStatusText.parentElement.classList.remove('loading');
                    return searchResult.files[0].id;
                } else {
                    if(driveStatusText) driveStatusText.textContent = "Cr√©ation fichier...";
                    const metadata = { name: filename, mimeType: mimeType };
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', new Blob([defaultContentStr], { type: mimeType }));

                    const responseCreate = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${googleAccessToken}` },
                        body: form
                    });
                    if (!responseCreate.ok) throw new Error(`Cr√©ation √©chou√©e: ${responseCreate.status}`);
                    const createdFile = await responseCreate.json();
                    if(driveStatusText) driveStatusText.textContent = "Fichier cr√©√©.";
                    driveStatusText.parentElement.classList.remove('loading');
                    return createdFile.id;
                }
            } catch (error) {
                console.error('Erreur Drive (findOrCreateFile):', error);
                showMessage(`Erreur Drive: ${error.message}`, 5000, true);
                if(driveStatusText) driveStatusText.textContent = "Erreur Fichier";
                driveStatusText.parentElement.classList.remove('loading');
                driveStatusText.parentElement.classList.add('error');
                return null;
            }
        }

        async function readFileContent(fileId) {
            if (!googleAccessToken || !fileId) return null;
            const driveStatusText = document.getElementById('drive-status-text');
            if(driveStatusText) driveStatusText.textContent = "Lecture fichier...";
            driveStatusText.parentElement.classList.add('loading');
            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                });
                if (!response.ok) throw new Error(`Lecture √©chou√©e: ${response.status}`);
                const content = await response.text();
                if(driveStatusText) driveStatusText.textContent = "Fichier lu.";
                driveStatusText.parentElement.classList.remove('loading');
                return content;
            } catch (error) {
                console.error('Erreur Drive (readFileContent):', error);
                showMessage(`Erreur lecture Drive: ${error.message}`, 5000, true);
                if(driveStatusText) driveStatusText.textContent = "Erreur Lecture";
                driveStatusText.parentElement.classList.remove('loading');
                driveStatusText.parentElement.classList.add('error');
                return null;
            }
        }

        async function updateFileContent(fileId, content) {
            if (!googleAccessToken || !fileId || isSavingDriveData) return false;
            isSavingDriveData = true;
            const driveStatusText = document.getElementById('drive-status-text');
            if(driveStatusText) driveStatusText.textContent = "Sauvegarde...";
            driveStatusText.parentElement.classList.add('loading');

            try {
                const contentToSave = (typeof content === 'string') ? content : JSON.stringify(content, null, 2);
                const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' },
                    body: contentToSave
                });
                if (!response.ok) throw new Error(`Sauvegarde √©chou√©e: ${response.status}`);
                if(driveStatusText) driveStatusText.textContent = "Sauvegard√©!";
                driveStatusText.parentElement.classList.remove('loading');
                driveStatusText.parentElement.classList.add('success');
                setTimeout(() => { 
                    if(driveStatusText.textContent === "Sauvegard√©!") driveStatusText.textContent = "Connect√©";
                    driveStatusText.parentElement.classList.remove('success');
                 }, 2000);
                return true;
            } catch (error) {
                console.error('Erreur Drive (updateFileContent):', error);
                showMessage(`Erreur sauvegarde Drive: ${error.message}`, 5000, true);
                 if(driveStatusText) driveStatusText.textContent = "Erreur Sauvegarde";
                 driveStatusText.parentElement.classList.remove('loading');
                 driveStatusText.parentElement.classList.add('error');
                return false;
            } finally {
                isSavingDriveData = false;
            }
        }
        
        async function loadLdcDataFromDrive() {
            if (!googleAccessToken) {
                console.log("Non connect√©, utilisation des donn√©es LDC initiales.");
                ldcDataStore = JSON.parse(JSON.stringify(initialLdcData));
                return;
            }
            console.log(`Chargement LDC depuis Drive (${LDC_DATA_FILENAME})...`);
            ldcDataStore.fileId = await findOrCreateFile(LDC_DATA_FILENAME, JSON.stringify(initialLdcData));
            if (ldcDataStore.fileId) {
                const content = await readFileContent(ldcDataStore.fileId);
                if (content && content.trim() !== "") {
                    try {
                        const parsedData = JSON.parse(content);
                        if (parsedData && typeof parsedData.teams === 'object' && Array.isArray(parsedData.seasons)) {
                            ldcDataStore = parsedData;
                            // Assurer que fileId et filename sont toujours pr√©sents dans ldcDataStore
                            ldcDataStore.fileId = ldcDataStore.fileId || await findOrCreateFile(LDC_DATA_FILENAME, JSON.stringify(initialLdcData));
                            ldcDataStore.filename = LDC_DATA_FILENAME;
                            console.log(`Donn√©es LDC charg√©es depuis Drive.`);
                        } else {
                            console.warn(`Donn√©es LDC malform√©es sur Drive. Utilisation des donn√©es initiales et tentative de sauvegarde.`);
                            ldcDataStore = JSON.parse(JSON.stringify(initialLdcData));
                            ldcDataStore.fileId = await findOrCreateFile(LDC_DATA_FILENAME, JSON.stringify(initialLdcData)); // R√©c LDC_DATA_FILENAME;
                            ldcDataStore.filename = LDC_DATA_FILENAME;
                             if(googleAccessToken && ldcDataStore.fileId) await saveLdcDataToDrive(true); 
                        }
                    } catch (e) {
                        console.error(`Erreur parsing LDC Drive:`, e); showMessage(`Donn√©es LDC Drive corrompues. Utilisation des donn√©es initiales.`, 7000, true);
                        ldcDataStore = JSON.parse(JSON.stringify(initialLdcData));
                        ldcDataStore.fileId = await findOrCreateFile(LDC_DATA_FILENAME, JSON.stringify(initialLdcData));
                        ldcDataStore.filename = LDC_DATA_FILENAME;
                        if(googleAccessToken && ldcDataStore.fileId) await saveLdcDataToDrive(true);
                    }
                } else {
                     console.log(`Fichier LDC vide sur Drive. Initialisation avec structure par d√©faut.`);
                     ldcDataStore = JSON.parse(JSON.stringify(initialLdcData));
                     ldcDataStore.fileId = ldcDataStore.fileId || await findOrCreateFile(LDC_DATA_FILENAME, JSON.stringify(initialLdcData));
                     ldcDataStore.filename = LDC_DATA_FILENAME;
                     if(googleAccessToken && ldcDataStore.fileId) await saveLdcDataToDrive(true); 
                }
            } else {
                console.warn(`Impossible trouver/cr√©er fichier LDC sur Drive. Utilisation des donn√©es initiales.`);
                showMessage(`Fichier LDC Drive inaccessible.`, 7000, true);
                ldcDataStore = JSON.parse(JSON.stringify(initialLdcData));
                // Pas de fileId, filename par d√©faut
                ldcDataStore.filename = LDC_DATA_FILENAME;
            }
        }
        async function saveLdcDataToDrive(isInitialSave = false) {
            if (!googleAccessToken) { if(!isInitialSave) showMessage("Connectez-vous pour sauvegarder LDC.", 3000, true); return; }
            if (!ldcDataStore || !ldcDataStore.filename) { console.error(`Donn√©es LDC ou nom de fichier manquant.`); return; }
            if (!ldcDataStore.fileId) { // Tente de r√©cup√©rer/cr√©er le fileId si manquant
                ldcDataStore.fileId = await findOrCreateFile(ldcDataStore.filename, JSON.stringify(ldcDataStore));
                if(!ldcDataStore.fileId){ showMessage(`Impossible de cr√©er/trouver le fichier LDC sur Drive.`, 5000, true); return; }
            }
            console.log(`Sauvegarde LDC sur Drive (File ID: ${ldcDataStore.fileId}).`);
            const success = await updateFileContent(ldcDataStore.fileId, ldcDataStore);
            if (success) { if(!isInitialSave) showMessage(`Donn√©es LDC sauvegard√©es !`, 2000); }
            else { if(!isInitialSave) showMessage(`√âchec sauvegarde LDC sur Drive.`, 3000, true); }
        }

        function populateLdcUI() {
            populateLdcSeasonSelector();
            const activeSeason = ldcDataStore.seasons.find(s => s.season_id === ldcDataStore.active_season_id);
            populateLdcTeamsGridDOM(ldcDataStore.teams); 
            if (activeSeason) {
                populateLdcFixturesDOM(activeSeason);
                displayLdcWinner(activeSeason);
            } else {
                document.getElementById('ldc-knockout-stages').innerHTML = '<p style="text-align:center; padding:20px; color: var(--current-text-light);">Aucune saison LDC active. Cr√©ez une nouvelle saison pour commencer.</p>';
                document.getElementById('ldc-winner-section').style.display = 'none';
            }
            const deleteBtn = document.getElementById(`delete-season-ldc-btn`);
            if(deleteBtn) deleteBtn.disabled = !googleAccessToken || !ldcDataStore.seasons || ldcDataStore.seasons.length <= 1;
            
            const saveBtn = document.getElementById('sauvegarde-ldc-btn');
            const newSeasonBtn = document.getElementById('nouvelle-saison-ldc-btn');
            if(saveBtn) saveBtn.disabled = !googleAccessToken;
            if(newSeasonBtn) newSeasonBtn.disabled = !googleAccessToken;
        }

        function populateLdcSeasonSelector() {
            const selector = document.getElementById(`ldc-season-selector`);
            const deleteBtn = document.getElementById(`delete-season-ldc-btn`);
            if (!selector) return;
            selector.innerHTML = '';
            if (ldcDataStore.seasons && ldcDataStore.seasons.length > 0) {
                ldcDataStore.seasons.sort((a,b) => b.season_id - a.season_id); 
                ldcDataStore.seasons.forEach(season => {
                    const option = document.createElement('option'); option.value = season.season_id;
                    option.textContent = season.nom_saison || `Saison LDC ${season.season_id}`;
                    if (season.season_id === ldcDataStore.active_season_id) option.selected = true;
                    selector.appendChild(option);
                });
                if(deleteBtn) deleteBtn.disabled = !googleAccessToken || ldcDataStore.seasons.length <= 1;
            } else { const option = document.createElement('option'); option.textContent = "Aucune saison"; selector.appendChild(option); if(deleteBtn) deleteBtn.disabled = true; }
        }

        function populateLdcTeamsGridDOM(teamsData) {
            const teamsGrid = document.getElementById('ldc-teams-grid'); if (!teamsGrid) return; teamsGrid.innerHTML = '';
            if(!teamsData || Object.keys(teamsData).length === 0) {teamsGrid.innerHTML = "<p>Aucune √©quipe LDC d√©finie.</p>"; return;}
            const activeSeason = ldcDataStore.seasons.find(s => s.season_id === ldcDataStore.active_season_id);
            const teamsInCurrentTournament = activeSeason ? activeSeason.teams_in_tournament || [] : Object.keys(teamsData); 

            teamsInCurrentTournament.forEach(teamName => {
                const teamData = teamsData[teamName];
                 if(teamName === "BYE" || !teamData) return;
                const teamCard = document.createElement('div'); teamCard.className = 'team-card';
                teamCard.innerHTML = `<img src="${BASE_URL}${teamData.logo}" alt="${teamName}"><h4>${teamName}</h4>`;
                teamsGrid.appendChild(teamCard);
            });
        }
        
        function generateKnockoutStage(stageName, numExpectedMatches, teamsAvailable, previousStageWinners = null) {
            const stageFixtures = [];
            let currentTeams = previousStageWinners ? [...previousStageWinners] : [...teamsAvailable];
             // Filtrer les "BYE" potentiels des tours pr√©c√©dents, sauf si c'est le seul "vainqueur"
            currentTeams = currentTeams.filter(team => team !== "BYE" || currentTeams.length === 1);

            if (currentTeams.length === 0 && numExpectedMatches > 0) { // Si aucune √©quipe n'est dispo
                for (let i = 0; i < numExpectedMatches; i++) {
                     stageFixtures.push({ home: `√Ä d√©terminer`, away: `√Ä d√©terminer`, scoreHome: null, scoreAway: null, match_id: `${stageName.toLowerCase().replace(/\s+/g, '-').replace(/[√®√©√™√´]/g,'e')}-${i}` });
                }
                return stageFixtures;
            }

            shuffleArray(currentTeams); 
            
            let teamsToPair = [...currentTeams];
            for (let i = 0; i < numExpectedMatches; i++) {
                let team1, team2;
                if (teamsToPair.length >= 2) {
                    team1 = teamsToPair.pop(); team2 = teamsToPair.pop();
                } else if (teamsToPair.length === 1) {
                    team1 = teamsToPair.pop(); team2 = "BYE"; // L'√©quipe restante obtient un BYE
                } else { // Plus assez d'√©quipes pour remplir tous les matchs pr√©vus
                    team1 = "√Ä d√©terminer"; team2 = "√Ä d√©terminer";
                }
                stageFixtures.push({ 
                    home: (i % 2 === 0 || team2 === "BYE" ? team1 : team2), // S'assure que BYE est toujours away si possible
                    away: (i % 2 === 0 || team2 === "BYE" ? team2 : team1),
                    scoreHome: null, scoreAway: null, 
                    match_id: `${stageName.toLowerCase().replace(/\s+/g, '-').replace(/[√®√©√™√´]/g,'e')}-${i}` 
                });
            } 
            return stageFixtures;
        }

        function createNewLdcSeason() {
            if (!ldcDataStore) return;
            const newSeasonId = ldcDataStore.seasons.length > 0 ? Math.max(...ldcDataStore.seasons.map(s => s.season_id)) + 1 : 1;
            const newSeasonName = `LDC Saison ${newSeasonId}`;
            let qualifiedTeams = Object.keys(ldcDataStore.teams || initialLdcData.teams); 
            if (qualifiedTeams.length < 2) { showMessage("Pas assez d'√©quipes pour d√©marrer une saison LDC.", 4000, true); return; }
            
            // D√©terminer le nombre d'√©quipes pour le tournoi (puissance de 2: 2, 4, 8, 16)
            let numTeamsForTournament;
            if (qualifiedTeams.length >= 16) numTeamsForTournament = 16;
            else if (qualifiedTeams.length >= 8) numTeamsForTournament = 8;
            else if (qualifiedTeams.length >= 4) numTeamsForTournament = 4;
            else if (qualifiedTeams.length >= 2) numTeamsForTournament = 2;
            else { showMessage("Pas assez d'√©quipes pour un tournoi.", 3000, true); return; }

            shuffleArray(qualifiedTeams);
            const selectedTeams = qualifiedTeams.slice(0, numTeamsForTournament);
            
            const newSeason = { 
                season_id: newSeasonId, nom_saison: newSeasonName, format: "elimination_directe",
                teams_in_tournament: [...selectedTeams], 
                phase_elimination: { huitiemes: [], quarts: [], demies: [], finale: [] },
                vainqueur: null
            };

            // G√©n√©rer la premi√®re phase en fonction du nombre d'√©quipes
            if (numTeamsForTournament === 16) newSeason.phase_elimination.huitiemes = generateKnockoutStage("Huiti√®mes", 8, selectedTeams);
            else if (numTeamsForTournament === 8) newSeason.phase_elimination.quarts = generateKnockoutStage("Quarts", 4, selectedTeams);
            else if (numTeamsForTournament === 4) newSeason.phase_elimination.demies = generateKnockoutStage("Demies", 2, selectedTeams);
            else if (numTeamsForTournament === 2) newSeason.phase_elimination.finale = generateKnockoutStage("Finale", 1, selectedTeams);

            ldcDataStore.seasons.push(newSeason); ldcDataStore.active_season_id = newSeasonId;
            populateLdcSeasonSelector(); populateLdcUI();
            showMessage(`Nouvelle saison LDC "${newSeasonName}" cr√©√©e avec ${numTeamsForTournament} √©quipes!`, 2500);
            if (googleAccessToken) saveLdcDataToDrive();
        }

        function deleteSelectedLdcSeason() {
            if (!ldcDataStore || !ldcDataStore.seasons || ldcDataStore.seasons.length <= 1) { showMessage("Impossible de supprimer la derni√®re saison LDC.", 3000, true); return; }
            const selector = document.getElementById(`ldc-season-selector`);
            const seasonIdToDelete = parseInt(selector.value);
            const seasonNameToDelete = ldcDataStore.seasons.find(s=>s.season_id === seasonIdToDelete)?.nom_saison || `Saison LDC ${seasonIdToDelete}`;
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer la "${seasonNameToDelete}" de la LDC ? Cette action est irr√©versible.`)) {
                ldcDataStore.seasons = ldcDataStore.seasons.filter(s => s.season_id !== seasonIdToDelete);
                if (ldcDataStore.active_season_id === seasonIdToDelete) ldcDataStore.active_season_id = ldcDataStore.seasons.length > 0 ? ldcDataStore.seasons[ldcDataStore.seasons.length - 1].season_id : null;
                populateLdcSeasonSelector(); populateLdcUI();
                showMessage("Saison LDC supprim√©e.", 2000); if (googleAccessToken) saveLdcDataToDrive();
            }
        }
         function handleLdcSeasonChange(event) {
            const selectedSeasonId = parseInt(event.target.value);
            if (!ldcDataStore || isNaN(selectedSeasonId)) return;
            ldcDataStore.active_season_id = selectedSeasonId;
            populateLdcUI();
            if(googleAccessToken) saveLdcDataToDrive(); 
        }

        function populateLdcFixturesDOM(activeSeason) {
            const knockoutStagesDiv = document.getElementById('ldc-knockout-stages');
            if (!knockoutStagesDiv || !activeSeason || !activeSeason.phase_elimination) { 
                if(knockoutStagesDiv) knockoutStagesDiv.innerHTML = '<p style="text-align:center; padding:20px; color: var(--current-text-light);">Aucun match d√©fini pour cette saison LDC.</p>'; 
                return; 
            }
            knockoutStagesDiv.innerHTML = ''; 
            const teamsInfo = ldcDataStore.teams || {}; 
            const stagesConfig = [
                { name: "Huiti√®mes de Finale", dataKey: 'huitiemes', numMatches: 8 }, 
                { name: "Quarts de Finale", dataKey: 'quarts', numMatches: 4  },
                { name: "Demi-Finales", dataKey: 'demies', numMatches: 2  }, 
                { name: "Finale", dataKey: 'finale', numMatches: 1 }
            ];
            
            let initialStageFound = false;
            for(const stageInfo of stagesConfig) {
                // On affiche une √©tape si elle a des matchs ou si c'est la premi√®re √©tape attendue pour le nombre d'√©quipes
                const isExpectedFirstStage = 
                    (activeSeason.teams_in_tournament.length <= 2 && stageInfo.dataKey === 'finale') ||
                    (activeSeason.teams_in_tournament.length > 2 && activeSeason.teams_in_tournament.length <= 4 && stageInfo.dataKey === 'demies') ||
                    (activeSeason.teams_in_tournament.length > 4 && activeSeason.teams_in_tournament.length <= 8 && stageInfo.dataKey === 'quarts') ||
                    (activeSeason.teams_in_tournament.length > 8 && stageInfo.dataKey === 'huitiemes');

                let stageData = activeSeason.phase_elimination[stageInfo.dataKey];

                if ((stageData && stageData.length > 0) || (isExpectedFirstStage && !initialStageFound) ) {
                    initialStageFound = true; // Marquer que la premi√®re √©tape pertinente a √©t√© trouv√©e

                    // Si stageData est vide mais c'est la premi√®re √©tape attendue, on la g√©n√®re "√† la vol√©e" pour l'affichage
                    // Cela peut arriver si une saison est cr√©√©e mais la premi√®re phase n'a pas √©t√© explicitement g√©n√©r√©e avec des matchs "√Ä d√©terminer"
                    if ((!stageData || stageData.length === 0) && isExpectedFirstStage) {
                         console.log(`G√©n√©ration √† la vol√©e pour affichage de ${stageInfo.name}`);
                         stageData = generateKnockoutStage(stageInfo.name, stageInfo.numMatches, activeSeason.teams_in_tournament);
                         // Note: Ne pas sauvegarder cette g√©n√©ration "√† la vol√©e" ici, c'est juste pour l'affichage initial.
                         // La vraie g√©n√©ration se fait dans createNewLdcSeason ou checkAndAdvanceLdcStage
                    }
                    
                    if (!stageData || stageData.length === 0) continue; // S'il n'y a toujours pas de donn√©es, on passe

                    const stageDiv = document.createElement('div'); stageDiv.className = 'knockout-stage'; 
                    stageDiv.innerHTML = `<h3>${stageInfo.name}</h3>`;
                    const table = document.createElement('table'); table.className = 'fixtures-table ldc-fixtures'; 
                    const tbody = document.createElement('tbody');
                    
                    stageData.forEach((match, matchIdx) => {
                        const row = document.createElement('tr');
                        const scoreHomeInputId = `ldc-${stageInfo.dataKey}-m${matchIdx}-h`; 
                        const scoreAwayInputId = `ldc-${stageInfo.dataKey}-m${matchIdx}-a`;
                        const scoreHomeVal = match.scoreHome !== null ? match.scoreHome : ''; 
                        const scoreAwayVal = match.scoreAway !== null ? match.scoreAway : '';

                        const homeTeamName = match.home || '√Ä d√©terminer';
                        const awayTeamName = match.away || '√Ä d√©terminer';
                        
                        const homeLogo = teamsInfo[homeTeamName] ? `<img src="${BASE_URL}${teamsInfo[homeTeamName].logo}" alt="${homeTeamName}" class="team-logo">` : (homeTeamName !== '√Ä d√©terminer' && homeTeamName !== 'BYE' ? '<span class="team-logo placeholder">?</span>' : '');
                        const awayLogo = teamsInfo[awayTeamName] ? `<img src="${BASE_URL}${teamsInfo[awayTeamName].logo}" alt="${awayTeamName}" class="team-logo">` : (awayTeamName !== '√Ä d√©terminer' && awayTeamName !== 'BYE' ? '<span class="team-logo placeholder">?</span>' : '');

                        row.innerHTML = `
                            <td>
                                <div class="fixture-match">
                                    <div class="fixture-team home">
                                        <span>${homeTeamName}</span>
                                        ${homeLogo}
                                    </div>
                                    <div class="fixture-score-inputs">
                                        <input type="number" class="fixture-score-input" id="${scoreHomeInputId}" value="${scoreHomeVal}" min="0" data-stagekey="${stageInfo.dataKey}" data-matchidx="${matchIdx}" data-team="home" ${homeTeamName === 'BYE' || awayTeamName === 'BYE' ? 'disabled' : ''}>
                                        <span class="vs-separator">-</span>
                                        <input type="number" class="fixture-score-input" id="${scoreAwayInputId}" value="${scoreAwayVal}" min="0" data-stagekey="${stageInfo.dataKey}" data-matchidx="${matchIdx}" data-team="away" ${homeTeamName === 'BYE' || awayTeamName === 'BYE' ? 'disabled' : ''}>
                                    </div>
                                    <div class="fixture-team away">
                                        ${awayLogo}
                                        <span>${awayTeamName}</span>
                                    </div>
                                </div>
                            </td>`;
                        tbody.appendChild(row);
                    });
                    table.appendChild(tbody); 
                    stageDiv.appendChild(table); 
                    knockoutStagesDiv.appendChild(stageDiv);
                }
            }
            if (!initialStageFound && knockoutStagesDiv.innerHTML === '') { // Si apr√®s tout √ßa, rien n'est affich√©
                 knockoutStagesDiv.innerHTML = '<p style="text-align:center; padding:20px; color: var(--current-text-light);">Commencez par cr√©er une saison et y ajouter des √©quipes.</p>';
            }
            document.querySelectorAll('#ldc-knockout-stages .fixture-score-input').forEach(input => input.addEventListener('change', handleLdcScoreChange));
        }

        function handleLdcScoreChange(event) {
            const input = event.target; const stageKey = input.dataset.stagekey; const matchIndex = parseInt(input.dataset.matchidx);
            const teamType = input.dataset.team; let score = input.value === '' ? null : parseInt(input.value);
            const activeSeason = ldcDataStore.seasons.find(s => s.season_id === ldcDataStore.active_season_id);
            if (!activeSeason || !activeSeason.phase_elimination || !activeSeason.phase_elimination[stageKey] || !activeSeason.phase_elimination[stageKey][matchIndex]) return;
            const match = activeSeason.phase_elimination[stageKey][matchIndex];
            if (score !== null && (isNaN(score) || score < 0)) { input.value = match[teamType === 'home' ? 'scoreHome' : 'scoreAway'] || ''; return; }
            
            if (teamType === 'home') match.scoreHome = score; else match.scoreAway = score;
            
            // D√©terminer le vainqueur
            if (match.home === "BYE") match.winner = match.away; // Si home est BYE, away gagne
            else if (match.away === "BYE") match.winner = match.home; // Si away est BYE, home gagne
            else if (typeof match.scoreHome === 'number' && typeof match.scoreAway === 'number') {
                if(match.scoreHome > match.scoreAway) match.winner = match.home;
                else if (match.scoreAway > match.scoreHome) match.winner = match.away;
                else match.winner = null; // Match nul (pas de vainqueur direct, √† g√©rer selon r√®gles LDC)
            } else match.winner = null;

            checkAndAdvanceLdcStage(activeSeason); 
            displayLdcWinner(activeSeason); 
            if(googleAccessToken) saveLdcDataToDrive();
        }

        function checkAndAdvanceLdcStage(activeSeason) {
            if (!activeSeason || !activeSeason.phase_elimination) return;
            const pe = activeSeason.phase_elimination;
            const stagesOrder = ['huitiemes', 'quarts', 'demies', 'finale'];
            let currentStageFullyPlayed = false; 
            let nextStageToGenerateKey = null; 
            let winnersFromCurrentStage = [];

            for(let i = 0; i < stagesOrder.length; i++) {
                const stageKey = stagesOrder[i];
                const nextKey = stagesOrder[i+1]; // Prochaine √©tape potentielle
                
                // Si l'√©tape actuelle n'existe pas ou est vide, on regarde si on doit la cr√©er
                if(!pe[stageKey] || pe[stageKey].length === 0) {
                    if (i === 0 && activeSeason.teams_in_tournament && activeSeason.teams_in_tournament.length > 0) { // Cas initial pour la 1ere phase
                         let numMatchesForFirstStage;
                         if (activeSeason.teams_in_tournament.length <= 2) { if(stageKey === 'finale') numMatchesForFirstStage = 1; else continue;}
                         else if (activeSeason.teams_in_tournament.length <= 4) { if(stageKey === 'demies') numMatchesForFirstStage = 2;  else continue;}
                         else if (activeSeason.teams_in_tournament.length <= 8) { if(stageKey === 'quarts') numMatchesForFirstStage = 4;  else continue;}
                         else if (activeSeason.teams_in_tournament.length <= 16) { if(stageKey === 'huitiemes') numMatchesForFirstStage = 8;  else continue;}
                         else continue; // Ne correspond √† aucune taille de tournoi g√©r√©e pour cette √©tape

                        pe[stageKey] = generateKnockoutStage(stageKey.charAt(0).toUpperCase() + stageKey.slice(1), numMatchesForFirstStage, activeSeason.teams_in_tournament);
                        console.log(`G√©n√©ration initiale pour ${stageKey} car vide.`);
                         // Pas besoin de nextStageToGenerateKey ici, on vient de la cr√©er. populateLdcUI sera appel√© apr√®s.
                        currentStageFullyPlayed = false; // Elle vient d'√™tre cr√©√©e, donc pas jou√©e
                        break; 
                    } else if (winnersFromCurrentStage.length > 0) { // Si on a des vainqueurs de l'√©tape d'avant
                        nextStageToGenerateKey = stageKey;
                    }
                    break; // Sortir de la boucle principale si l'√©tape actuelle est vide et qu'on ne peut la g√©n√©rer
                }

                // V√©rifier si tous les matchs de l'√©tape actuelle ont un vainqueur
                const allMatchesInStageHaveWinner = pe[stageKey].every(m => {
                    if (m.home === "BYE") { m.winner = m.away; return true; }
                    if (m.away === "BYE") { m.winner = m.home; return true; }
                    return m.winner;
                });

                if(allMatchesInStageHaveWinner) { 
                    currentStageFullyPlayed = true; 
                    winnersFromCurrentStage = pe[stageKey].map(m => m.winner).filter(Boolean); 
                    if(nextKey && (!pe[nextKey] || pe[nextKey].length === 0)) { // Si l'√©tape suivante n'a pas encore de matchs
                        nextStageToGenerateKey = nextKey; 
                        break; 
                    } else if (!nextKey && stageKey === 'finale') { // C'est la finale et elle est jou√©e
                         activeSeason.vainqueur = winnersFromCurrentStage[0]; // Le vainqueur du tournoi
                         console.log("Vainqueur du tournoi:", activeSeason.vainqueur);
                    }
                } else { 
                    currentStageFullyPlayed = false; 
                    winnersFromCurrentStage = []; // Pas tous les matchs jou√©s, on ne peut pas d√©terminer les vainqueurs pour l'√©tape suivante
                    break; 
                }
            }
            
            if (nextStageToGenerateKey && winnersFromCurrentStage.length > 0) {
                const numNextMatchesMap = { 'quarts': 4, 'demies': 2, 'finale': 1 };
                const numNextMatches = numNextMatchesMap[nextStageToGenerateKey] || 0;

                if (numNextMatches > 0 && (winnersFromCurrentStage.length >= numNextMatches || winnersFromCurrentStage.length >=1 )) { // S'il y a assez de vainqueurs pour au moins un match de la phase suivante, ou si c'est la finale avec au moins 1 qualifi√©
                    console.log(`G√©n√©ration de ${nextStageToGenerateKey} avec ${winnersFromCurrentStage.length} vainqueurs.`);
                    pe[nextStageToGenerateKey] = generateKnockoutStage(
                        nextStageToGenerateKey.charAt(0).toUpperCase() + nextStageToGenerateKey.slice(1), 
                        Math.ceil(winnersFromCurrentStage.length / 2), // Nombre de matchs bas√© sur les vainqueurs dispo
                        [], // Pas de nouvelles √©quipes, on utilise les vainqueurs
                        winnersFromCurrentStage
                    );
                } else {
                    console.log(`Pas assez de vainqueurs (${winnersFromCurrentStage.length}) pour g√©n√©rer ${nextStageToGenerateKey} qui n√©cessite au moins ${numNextMatches*2} √©quipes (ou 1 pour la finale).`);
                }
            }
            // Toujours repeupler l'UI pour refl√©ter les changements, m√™me si aucune nouvelle phase n'est g√©n√©r√©e (ex: scores mis √† jour)
            populateLdcFixturesDOM(activeSeason); 
        }
        
        function displayLdcWinner(activeSeason) {
            const winnerSection = document.getElementById('ldc-winner-section'); const winnerDisplay = document.getElementById('ldc-winner-display');
            if (!winnerSection || !winnerDisplay) return;
            if (activeSeason && activeSeason.vainqueur && activeSeason.vainqueur !== "BYE") {
                const winnerTeamData = ldcDataStore.teams[activeSeason.vainqueur];
                const logoHtml = winnerTeamData ? `<img src="${BASE_URL}${winnerTeamData.logo}" alt="${activeSeason.vainqueur}" class="team-logo" style="width:50px; height:50px; margin-right:15px; border-radius:50%; background:rgba(255,255,255,0.1); padding:3px;">` : '';
                winnerDisplay.innerHTML = `<i class="fas fa-trophy trophy-ldc" style="font-size: 3em; margin-right: 15px; color: var(--ldc-gold);"></i> ${logoHtml} ${activeSeason.vainqueur}`;
                winnerSection.style.display = 'block';
            } else winnerSection.style.display = 'none';
        }
        
        const allNavLinks = document.querySelectorAll('header nav ul li a');
        const observer = new IntersectionObserver((entries, obs) => { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.style.opacity = '1'; entry.target.style.transform = 'translateY(0)'; obs.unobserve(entry.target); } }); }, { threshold: 0.05 }); 
        function observeActiveTabSections() { document.querySelectorAll('.section').forEach(el => { if (el.style.opacity !== '1') { el.style.opacity = '0'; el.style.transform = 'translateY(25px)'; } observer.observe(el) });}
        
        const hamburger = document.querySelector('.hamburger'); const nav = document.querySelector('header nav');
        if (hamburger && nav) {
            hamburger.addEventListener('click', () => { nav.classList.toggle('active'); const icon = hamburger.querySelector('i'); icon.classList.toggle('fa-bars'); icon.classList.toggle('fa-times'); });
            document.addEventListener('click', (e) => { const target = e.target; const isClickInsideNav = nav.contains(target) || hamburger.contains(target); if (!isClickInsideNav && nav.classList.contains('active')) { nav.classList.remove('active'); hamburger.querySelector('i').className = 'fas fa-bars'; } });
        }
        allNavLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 992 && nav.classList.contains('active')) { nav.classList.remove('active'); hamburger.querySelector('i').className = 'fas fa-bars'; }
                allNavLinks.forEach(l => l.classList.remove('active-nav-link'));
                link.classList.add('active-nav-link');
            });
        });
        
        const ldcMusicBtn = document.getElementById('ldc-music-btn');
        if (ldcMusicBtn) { 
            ldcMusicBtn.addEventListener('click', () => {
                initAudioContext(); 
                if (!ldcAudioPlayer) ldcAudioPlayer = document.getElementById('ldc-audio-player'); 
                if (!ldcAudioPlayer) {console.error("Element audio LDC non trouv√©"); return;}
                const icon = ldcMusicBtn.querySelector('i');
                if (ldcAudioPlayer.paused || ldcAudioPlayer.ended) {
                    ldcAudioPlayer.play().catch(e => {
                        console.warn("Erreur lecture auto audio LDC (interaction requise?):", e);
                        showMessage("Cliquez √† nouveau pour jouer l'hymne.", 2000);
                    });
                    icon.classList.remove('fa-play'); icon.classList.add('fa-pause');
                } else {
                    ldcAudioPlayer.pause();
                    icon.classList.remove('fa-pause'); icon.classList.add('fa-play');
                }
            });
        }
        
        document.getElementById('nouvelle-saison-ldc-btn')?.addEventListener('click', createNewLdcSeason);
        document.getElementById('sauvegarde-ldc-btn')?.addEventListener('click', () => saveLdcDataToDrive());
        document.getElementById('delete-season-ldc-btn')?.addEventListener('click', deleteSelectedLdcSeason);
        document.getElementById('ldc-season-selector')?.addEventListener('change', handleLdcSeasonChange);
        document.getElementById('signin-button')?.addEventListener('click', handleAuthClick);

        document.addEventListener('DOMContentLoaded', async () => {
            messageArea = document.getElementById('message-area');
            ldcAudioPlayer = document.getElementById('ldc-audio-player'); 
            
            // Tenter de r√©cup√©rer un token existant (si la page est recharg√©e)
            const storedToken = localStorage.getItem('google_access_token_ldc');
            if (storedToken) {
                googleAccessToken = storedToken;
                 // Id√©alement, v√©rifier la validit√© du token ici avant de juste supposer qu'il est bon
                console.log("Token r√©cup√©r√© du localStorage.");
            }
            
            await checkAndInitGis(); // Initialise GIS et met √† jour l'UI si token Client est pr√™t
                                     // updateAuthUI sera appel√© dans gisInitInternal ou tokenCallback

            if(googleAccessToken){ // Si on a un token (du localStorage par exemple)
                updateAuthUI(true); // Mettre √† jour l'UI pour refl√©ter l'√©tat connect√©
                await loadLdcDataFromDrive(); // Charger les donn√©es
            } else {
                updateAuthUI(false); // S'assurer que l'UI est en mode d√©connect√©
                 // Utiliser les donn√©es initiales si non connect√©
                ldcDataStore = JSON.parse(JSON.stringify(initialLdcData));
            }
            
            populateLdcUI(); 
            observeActiveTabSections();
            
            const activeNavLink = document.querySelector('header nav ul li a[href="champions.html"]');
            if(activeNavLink) activeNavLink.classList.add('active-nav-link');

            console.log("Page Ligue des Champions Initialis√©e (v3 - Style LDC).");
        });
    </script>
</body>
</html>
