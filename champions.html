<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ligue des Champions des Peluches - Road to Glory!</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Oswald:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Palette UCL inspir√©e de l'image */
            --ucl-deep-purple: #100822; 
            --ucl-mid-purple: #231249;  
            --ucl-light-accent: #8A2BE2; 
            --ucl-connector-blue: #60A5FA; 
            --ucl-connector-blue-transparent: rgba(96, 165, 250, 0.7);
            --ucl-team-bg: rgba(230, 230, 240, 0.9); 
            --ucl-team-bg-winner: rgba(96, 165, 250, 0.8); 
            --ucl-text-primary: #FFFFFF; 
            --ucl-text-secondary: #B0B0D0; 
            --ucl-input-bg: rgba(0, 0, 0, 0.3);
            --ucl-border-color: rgba(96, 165, 250, 0.3);

            --neon-green: #39FF14; 
            --neon-red: #FF3131; 
            --neon-yellow: #FFF01F;

            --current-bg-color: var(--ucl-deep-purple);
            --current-primary-color: var(--ucl-mid-purple);
            --current-secondary-color: var(--ucl-light-accent);
            --current-accent-gold: #FFD700; 
            --current-text-light: var(--ucl-text-primary);
            --current-card-bg: rgba(35, 18, 73, 0.5); 
            --current-border-color: var(--ucl-border-color);
            --current-line-color: var(--ucl-connector-blue);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Open Sans', sans-serif; line-height: 1.6; color: var(--current-text-light);
            background-color: var(--ucl-deep-purple);
            background-image: radial-gradient(circle at top right, var(--ucl-mid-purple) 0%, transparent 50%),
                              radial-gradient(circle at bottom left, var(--ucl-mid-purple) 0%, transparent 40%),
                              linear-gradient(135deg, var(--ucl-deep-purple) 0%, var(--ucl-mid-purple) 60%, var(--ucl-deep-purple) 100%);
            overflow-x: hidden; scroll-behavior: smooth;
            min-height: 100vh;
        }
        .container { width: 100%; max-width: 1600px; margin: 0 auto; padding: 0 20px; }

        h1, h2, h3, h4, .section-title {
            font-family: 'Oswald', sans-serif; font-weight: 500;
            color: var(--current-text-light);
            text-transform: uppercase; letter-spacing: 1.5px;
            text-shadow: 0 0 10px rgba(96, 165, 250, 0.3);
        }
        .page-title-bar h1 { color: var(--current-accent-gold); text-shadow: 0 0 12px rgba(255,215,0,0.7); }
        
        header {
            background-color: rgba(16, 8, 34, 0.7); 
            backdrop-filter: blur(10px);
            padding: 10px 0; position: sticky; top: 0; z-index: 1000;
            border-bottom: 1px solid var(--ucl-border-color);
        }
        .logo img { filter: drop-shadow(0 0 8px var(--current-accent-gold));} 
        .logo h1 { color: var(--current-accent-gold); }
        
        #drive-status { display: inline-flex; align-items: center; gap: 5px; font-size: 0.85em; padding: 4px 8px; border-radius: 4px; transition: color 0.3s ease, border-color 0.3s ease; white-space: nowrap; border: 1px solid var(--ucl-connector-blue); }
        #drive-status.loading { color: var(--neon-yellow); border-color: var(--neon-yellow); }
        #drive-status.success { color: var(--neon-green); border-color: var(--neon-green); }
        #drive-status.error { color: var(--neon-red); border-color: var(--neon-red); }
        #drive-status i { margin-right: 5px; color: var(--ucl-connector-blue); }

        #signin-button { background-color: var(--ucl-connector-blue); color: var(--ucl-deep-purple); padding: 7px 12px; font-size: 0.85em; border: none; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; white-space: nowrap;}
        #signin-button:hover:not(:disabled) { background-color: var(--ucl-text-primary); }
        #signin-button:disabled { opacity: 0.5; cursor: not-allowed; }


        nav ul li a:hover, nav ul li a.active-nav-link {
            color: var(--ucl-connector-blue); 
            background-color: rgba(96, 165, 250, 0.1); 
            border-color: var(--ucl-connector-blue);
            box-shadow: 0 0 10px rgba(96, 165, 250, 0.4); 
        }
        .hamburger { display: none; font-size: 1.8rem; color: var(--current-text-light); cursor: pointer; z-index: 1001; margin-left:15px;}


        .page-title-bar {
            background: transparent; 
            padding: 40px 0; margin-bottom: 30px;
            border-bottom: 2px solid var(--ucl-connector-blue-transparent);
        }
        .page-title-bar h1 { font-size: 3rem; }
        .page-title-bar h1 i { margin: 0 15px; animation: subtleTrophyPulse 2s infinite ease-in-out; }
        @keyframes subtleTrophyPulse { 0%, 100% {transform: scale(1);} 50% {transform: scale(1.1);} }


        .section { 
            margin-bottom: 40px; background-color: var(--current-card-bg); 
            border-radius: 10px; padding: 25px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.5); 
            border: 1px solid var(--current-border-color);
        }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid var(--current-border-color); }
        .section-title { font-size: 2rem; color: var(--current-text-light);}
        
        .action-buttons { display:flex; align-items:center; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;}
        .league-music-btn {
            background-color: var(--ucl-connector-blue); color: var(--ucl-deep-purple); border: 1px solid var(--ucl-deep-purple);
            padding: 10px 18px; border-radius: 25px; font-family: 'Oswald', sans-serif;
            cursor: pointer; transition: all 0.3s ease; font-weight: 600;
        }
        .league-music-btn:hover { background-color: var(--ucl-mid-purple); color: var(--ucl-connector-blue); border-color: var(--ucl-connector-blue);}
        .league-music-btn i { margin-right: 8px; }

        .season-selector-container { display: flex; align-items: center; gap: 10px; }
        .season-selector-container label { font-weight: 600; color: var(--current-text-light); font-family: 'Oswald'; }
        .season-selector-container select {
            padding: 8px 12px; border-radius: 4px; border: 1px solid var(--ucl-border-color);
            font-family: 'Open Sans'; font-size: 0.9rem; background-color: rgba(16, 8, 34, 0.7); color:var(--current-text-light);
        }
        .season-selector-container select option { background-color: var(--ucl-deep-purple); color: var(--current-text-light); }

        .nouvelle-saison-btn, .sauvegarde-json-btn, .delete-season-btn {
            padding: 10px 20px; font-size: 1rem; font-family: 'Oswald', sans-serif; text-transform: uppercase;
            color: var(--ucl-deep-purple); background-color: var(--ucl-connector-blue);
            border: none; border-radius: 5px; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: all 0.3s ease;
        }
        .nouvelle-saison-btn:hover:not(:disabled), .sauvegarde-json-btn:hover:not(:disabled), .delete-season-btn:hover:not(:disabled) { 
            transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
        }
        .nouvelle-saison-btn:hover:not(:disabled) { background-color: var(--ucl-light-accent); color: var(--ucl-text-primary); }
        .nouvelle-saison-btn:disabled, .sauvegarde-json-btn:disabled, .delete-season-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .sauvegarde-json-btn { background-color: var(--current-accent-gold); color: var(--ucl-deep-purple); }
        .sauvegarde-json-btn:hover:not(:disabled) { background-color: #fff; color:var(--current-accent-gold); border: 1px solid var(--current-accent-gold); }
        .delete-season-btn { background-color: var(--neon-red); margin-left: 5px; color: #fff;}
        .delete-season-btn:hover:not(:disabled) { background-color: #cc2828; }


        #ldc-fixtures-section { background-color: transparent; border: none; box-shadow: none; padding: 0;}
        .knockout-bracket-visual {
            display: flex;
            justify-content: space-between;
            align-items: stretch; 
            padding: 20px 10px;
            min-height: 600px; 
            width: 100%;
            overflow-x: auto; 
        }

        .bracket-column {
            display: flex;
            flex-direction: column;
            justify-content: space-around; 
            align-items: center;
            flex-grow: 1; 
            padding: 0 10px; 
            gap: 10px; 
            position: relative; 
        }
        .bracket-column.rounds-8-4 { min-width: 200px; }
        .bracket-column.round-semi { min-width: 200px; }

        .bracket-match-item {
            display: flex;
            flex-direction: column; 
            align-items: center;
            width: 100%; 
            position: relative; 
            margin: 10px 0; 
        }

        .team-slot {
            background-color: var(--ucl-team-bg);
            color: var(--ucl-deep-purple); 
            padding: 8px 12px;
            margin: 2px 0; 
            border-radius: 4px;
            width: 100%;
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative; 
        }
        .team-slot img.team-logo {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            object-fit: contain;
        }
        .team-slot .team-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .team-slot input[type="number"].score-input-bracket {
            width: 30px;
            padding: 2px;
            text-align: center;
            font-size: 0.8rem;
            margin-left: 5px;
            border: 1px solid var(--ucl-border-color);
            background-color: rgba(255,255,255,0.7);
            color: var(--ucl-deep-purple);
            border-radius: 3px;
        }
        .team-slot input[type="number"].score-input-bracket::-webkit-outer-spin-button,
        .team-slot input[type="number"].score-input-bracket::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        .team-slot.winner { background-color: var(--ucl-team-bg-winner); color: var(--ucl-text-primary); }
        .team-slot.loser { opacity: 0.7; }


        .match-connectors {
            position: absolute;
            top: 50%;
            left: 100%; 
            height: 100%;
            width: 30px; 
            display: flex;
            align-items: center;
        }
        .match-connectors.left-side {
            left: auto;
            right: 100%;
        }

        .connector {
            background-color: var(--ucl-connector-blue);
            position: absolute;
            z-index: -1; 
        }
        .connector.horizontal { height: 2px; }
        .connector.vertical { width: 2px; }
        
        .match-label {
            position: absolute;
            background-color: var(--ucl-mid-purple);
            color: var(--ucl-text-secondary);
            font-size: 0.7rem;
            padding: 1px 4px;
            border-radius: 3px;
            border: 1px solid var(--ucl-connector-blue-transparent);
            z-index: 1;
        }

        .bracket-centerpiece-visual {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0 20px; 
            min-width: 100px; 
            position: relative;
        }
        .bracket-centerpiece-visual .trophy-icon {
            font-size: 5rem; 
            color: var(--current-accent-gold);
            filter: drop-shadow(0 0 15px var(--current-accent-gold));
            margin-bottom: 20px;
        }
        .final-match-placeholder { width: 220px; }
        

        .teams-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; } 
        .team-card { 
            background-color: var(--current-card-bg); 
            border: 1px solid var(--current-border-color); 
            transition: all 0.3s ease; 
            border-radius: 10px; padding: 15px; text-align: center; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.06);
        }
        .team-card:hover { transform: translateY(-5px) scale(1.03); border-color: var(--ucl-connector-blue); box-shadow: 0 8px 20px rgba(96, 165, 250, 0.2);}
        .team-card img { width: 60px; height: 60px; object-fit: contain; margin-bottom: 10px; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));}
        .team-card h4 { color: var(--ucl-text-primary); font-size: 1.1rem; margin-bottom: 5px; }

        footer { 
            background-color: transparent; 
            color: var(--ucl-text-secondary); 
            padding: 40px 0 20px; 
            border-top: 1px solid var(--ucl-border-color); 
            margin-top: 50px;
        }
        .footer-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 30px; }
        .footer-section h3 { font-size: 1.2rem; margin-bottom: 20px; color: var(--current-accent-gold); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--current-accent-gold); padding-bottom: 10px; display: inline-block;}
        .footer-section ul { list-style: none; padding: 0;}
        .footer-section ul li { margin-bottom: 10px; }
        .footer-section ul li a { color: var(--ucl-text-secondary); text-decoration: none; transition: color 0.3s ease, padding-left 0.3s ease; display: block; }
        .footer-section ul li a:hover { color: var(--current-accent-gold); padding-left: 5px; }
        .copyright { text-align: center; margin-top: 40px; padding-top: 30px; border-top: 1px solid var(--ucl-border-color); font-size: 0.9rem; color: var(--ucl-text-secondary); opacity: 0.7; }
        
        .message-area {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            background-color: var(--ucl-mid-purple); 
            color: var(--current-text-light);
            padding: 12px 25px; border-radius: 6px; z-index: 3000; 
            opacity: 0; visibility: hidden; transition: all 0.5s ease; pointer-events: none;
            font-size: 0.95em; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            max-width: 90%; text-align: center; 
            border: 1px solid var(--ucl-light-accent);
        }
        .message-area.visible { opacity: 1; visibility: visible; transform: translate(-50%, -15px) ; pointer-events: auto; }
        .message-area.error-message { background-color: rgba(var(--neon-red-rgb, 255, 49, 49), 0.8); border: 1px solid var(--neon-red); text-shadow: 0 0 3px black;}


        @media (max-width: 1200px) {
            .knockout-bracket-visual { padding: 15px 5px; }
            .bracket-column.rounds-8-4, .bracket-column.round-semi { min-width: 160px; }
            .team-slot { font-size: 0.8rem; padding: 6px 8px; }
            .team-slot img.team-logo { width: 18px; height: 18px; margin-right: 6px; }
        }
        @media (max-width: 992px) {
            .header-container { flex-wrap: wrap; }
            .header-actions { order: 3; width: 100%; justify-content: center; margin-top:10px; }
            nav {order:1; flex-grow: 0; margin-right: auto;} 
            .hamburger {display: block; order: 2; margin-left: 15px;}
            nav.active { max-height: 500px; }
            nav ul { flex-direction: column; padding: 10px 0; gap: 0; background-color: rgba(16, 8, 34, 0.95); }
            nav ul li { margin-left: 0; width: 100%; }
            nav ul li a { padding: 15px 20px; border-bottom: 1px solid var(--ucl-border-color); border-radius:0; justify-content: flex-start; }
            nav ul li a:hover, nav ul li a.active-nav-link { background-color: rgba(96, 165, 250, 0.2); border-color:transparent; color: var(--ucl-connector-blue); transform: none; box-shadow: none;}
            .teams-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); } 
            .bracket-centerpiece-visual .trophy-icon { font-size: 4rem; }
        }
        @media (max-width: 768px) {
            .logo h1 { font-size: 1.5rem; }
            .page-title-bar h1 {font-size: 2rem;}
            .section-title { font-size: 1.6rem; }
            .action-buttons { flex-direction: column; align-items: stretch;}
            .season-selector-container { flex-direction: column; align-items: stretch; width: 100%;}
            .season-selector-container select { width: 100%; margin-bottom: 10px;}
        }
         @media (max-width: 576px) {
            .logo h1 { font-size: 1.3rem; }
            nav ul li a {font-size: 0.9rem; padding: 10px 15px;} 
            .page-title-bar h1 {font-size: 1.8rem;}
            .section { padding: 20px; }
            .section-title { font-size: 1.6rem; }
            .nouvelle-saison-btn, .sauvegarde-json-btn, .delete-season-btn { padding: 10px 15px; font-size: 0.9rem;}
            .team-slot { font-size: 0.75rem; padding: 5px; }
            .team-slot img.team-logo { width: 16px; height: 16px; }
            .team-slot input[type="number"].score-input-bracket { width: 25px; font-size:0.7rem; }
            .footer-container { grid-template-columns: 1fr; text-align: center; }
            .footer-section h3 { display: block; border-bottom: none; padding-bottom: 5px; margin-bottom: 10px; }
            .footer-section h3::after { content:""; display:block; width:50px; height:1px; background:var(--current-accent-gold); margin: 5px auto 0; }
        }

    </style>
</head>
<body>
    <!-- HTML du header, titre de page, boutons d'action, section √©quipes (identique) -->
    <header>
        <div class="container header-container">
            <a href="index.html" class="logo"> 
                <img src="https://ironworkout.github.io/paul.wallon.bts.sio/OIP.png" alt="Logo Championnat Peluches √âlite">
                <h1>Peluche √âlite</h1>
            </a>
            <nav>
                <ul>
                    <li><a href="index.html"><i class="fas fa-shield-alt"></i> Ligues Nat.</a></li>
                    <li><a href="champions.html" class="active-nav-link"><i class="fas fa-trophy"></i> LDC</a></li> 
                    <li><a href="index.html#actualites-section-container"><i class="fas fa-newspaper"></i> Actualit√©s</a></li>
                </ul>
            </nav>
            <div class="header-actions">
                 <div id="drive-status" style="display: none;"> 
                    <i class="fab fa-google-drive"></i> <span id="drive-status-text">D√©connect√©</span>
                 </div>
                <button id="signin-button" disabled><i class="fab fa-google"></i> Drive</button>
            </div>
            <div class="hamburger"><i class="fas fa-bars"></i></div>
        </div>
    </header>

    <div class="page-title-bar">
        <div class="container">
            <h1><i class="fas fa-trophy"></i> Ligue des Champions des Peluches <i class="fas fa-star"></i></h1>
        </div>
    </div>

    <div class="tab-content active" id="ldc-content">
        <div class="container ldc-theme">
             <div class="section action-buttons">
                <button class="league-music-btn" id="ldc-music-btn" data-league-audio="ldc" aria-label="Jouer/Mettre en pause l'hymne de la LDC">
                    <i class="fas fa-play"></i> Hymne LDC
                </button>
            </div>
             <div class="section action-buttons">
                 <div class="season-selector-container">
                     <label for="ldc-season-selector">Saison LDC :</label>
                     <select id="ldc-season-selector" data-league="ldc"></select>
                     <button class="delete-season-btn" id="delete-season-ldc-btn" title="Supprimer la saison LDC s√©lectionn√©e" disabled><i class="fas fa-trash-alt"></i></button>
                 </div>
                 <button class="nouvelle-saison-btn" id="nouvelle-saison-ldc-btn" disabled><i class="fas fa-plus-circle"></i> Nouvelle Saison LDC</button>
                 <button class="sauvegarde-json-btn" id="sauvegarde-ldc-btn" disabled><i class="fas fa-save"></i> Sauvegarder LDC</button>
            </div>

            <div class="section" id="ldc-teams-section">
                <div class="section-header"><h2 class="section-title">√âquipes Qualifi√©es</h2></div>
                <div class="section-content"><div class="teams-grid" id="ldc-teams-grid"></div></div>
            </div>

            <div class="section" id="ldc-fixtures-section">
                <div class="section-header"><h2 class="section-title">Phase √† √âlimination Directe</h2></div>
                <div class="knockout-bracket-visual" id="ldc-knockout-stages">
                    <!-- Le bracket visuel sera g√©n√©r√© ici par JavaScript -->
                </div>
            </div>
            
            <div class="section" id="ldc-winner-section" style="text-align: center; display:none;">
                 <h2 class="section-title">üèÜ CHAMPION LDC üèÜ</h2>
                 <div id="ldc-winner-display" style="font-size: 2.5rem; color: var(--current-accent-gold); margin-top: 20px;">
                 </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container footer-container">
            <div class="footer-section"><h3>Navigation</h3><ul><li><a href="index.html">Accueil Championnats</a></li><li><a href="champions.html">Ligue des Champions</a></li><li><a href="index.html#actualites-section-container">Actualit√©s</a></li></ul></div>
            <div class="footer-section"><h3>Contact</h3><ul><li><a href="mailto:contact@peluche-elite.com">Email</a></li><li><a href="#">FAQ</a></li></ul></div>
        </div>
        <div class="copyright">¬© 2025 Championnat Peluche √âlite. Tous droits r√©serv√©s.</div>
    </footer>

    <div id="message-area" class="message-area" role="status" aria-live="polite"></div>
    <audio id="ldc-audio-player" src="https://ironworkout.github.io/paul.wallon.bts.sio/ldc.mp3" loop preload="auto"></audio>

    <script>
        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const LDC_DATA_FILENAME = 'peluches_ldc_data.json'; 
        const BASE_URL = "https://ironworkout.github.io/paul.wallon.bts.sio/";
        const GIS_CHECK_INTERVAL = 100; 
        const GIS_MAX_RETRIES = 50; 

        const initialLdcData = {
            teams: { 
                "PSG Peluches": { "logo": "psg.png" }, "Olympique Ours": { "logo": "oo.png" },
                "Valenciennes FC": { "logo": "vafc.png" }, "Toulours FC": { "logo": "tfc.png" },
                "Peluche FC": { "logo": "pfc.png"}, "AS Carrotes": {"logo": "ascl.png"},
                "AS Saint-Ettours": { "logo": "asset.png"}, "Patapouf FC": { "logo": "patapouf.png"} ,
                "DreamTeam Fluffies": { "logo": "pfc.png" }, "Galactic Teddies": { "logo": "oo.png"},
                "United Plushies": { "logo": "tfc.png" }, "Cotton Ballers FC": { "logo": "vafc.png"},
                "The Snuggle Squad": { "logo": "ascl.png" }, "Wooly Wanderers": { "logo": "asset.png"},
                "Fuzzy Strikers": { "logo": "patapouf.png" }, "Velvet Victory": { "logo": "psg.png"}
            },
            seasons: [], active_season_id: null, fileId: null, filename: LDC_DATA_FILENAME
        };
        
        let ldcDataStore = JSON.parse(JSON.stringify(initialLdcData));

        let googleAccessToken = null, tokenClient = null;
        let isSavingDriveData = false; 
        let messageArea = null;
        let messageTimeoutId = null;
        let gisCheckRetries = 0;
        let audioContext = null;
        let ldcAudioPlayer = null;

        // --- D√âFINITIONS DES FONCTIONS ---

        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
        
        function showMessage(msg, duration = 3000, isError = false) {
            if (!messageArea) messageArea = document.getElementById('message-area'); // Initialisation si pas d√©j√† fait
            if (!messageArea) return; // Si l'√©l√©ment n'existe toujours pas
            messageArea.textContent = msg;
            messageArea.classList.add('visible');
            if(isError) messageArea.classList.add('error-message'); else messageArea.classList.remove('error-message');
            clearTimeout(messageTimeoutId);
            messageTimeoutId = setTimeout(() => { messageArea.classList.remove('visible'); }, duration);
        }

        function initAudioContext() {
            if (audioContext) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) { console.warn("Web Audio API non support√©e.", e); }
        }

        async function gisInitInternal() {
            console.log("Tentative d'initialisation de Google Identity Services...");
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                console.log("GIS pr√™t. Initialisation du client token.");
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: GOOGLE_DRIVE_SCOPES,
                    callback: tokenCallback,
                    error_callback: handleTokenError
                });
                updateAuthUI(false); 
                document.getElementById('signin-button').disabled = false;
                document.getElementById('drive-status').style.display = 'inline-flex';
            } else {
                console.log("GIS non encore pr√™t. Nouvelle tentative...");
                gisCheckRetries++;
                if (gisCheckRetries < GIS_MAX_RETRIES) {
                    setTimeout(gisInitInternal, GIS_CHECK_INTERVAL);
                } else {
                    console.error("√âchec du chargement de Google Identity Services apr√®s plusieurs tentatives.");
                    showMessage("Erreur: Service Google indisponible.", 5000, true);
                    updateAuthUI(false);
                    const driveStatus = document.getElementById('drive-status');
                    if(driveStatus) {
                        driveStatus.innerHTML = '<i class="fab fa-google-drive"></i> <span id="drive-status-text">Erreur GIS</span>';
                        driveStatus.className = 'drive-status error'; // Correction pour utiliser la classe de statut
                    }
                }
            }
        }

        function checkAndInitGis() {
            if (window.google && window.google.accounts && window.google.accounts.id) {
                gisInitInternal();
            } else {
                const script = document.createElement('script');
                script.src = 'https://accounts.google.com/gsi/client';
                script.async = true;
                script.defer = true;
                script.onload = gisInitInternal;
                script.onerror = () => {
                    console.error("√âchec du chargement du script GSI.");
                    showMessage("Impossible de charger les services Google.", 5000, true);
                     const driveStatus = document.getElementById('drive-status');
                     if(driveStatus) {
                        driveStatus.style.display = 'inline-flex';
                        driveStatus.innerHTML = '<i class="fab fa-google-drive"></i> <span id="drive-status-text">√âchec chargement GIS</span>';
                        driveStatus.className = 'drive-status error'; // Correction
                     }
                };
                document.head.appendChild(script);
            }
        }
        
        function handleTokenError(error) {
            console.error('Erreur de token:', error);
            showMessage(`Erreur d'authentification Google: ${error.message || error.details || 'Erreur inconnue'}`, 5000, true);
            googleAccessToken = null;
            updateAuthUI(false);
        }

        async function tokenCallback(tokenResponse) {
            if (tokenResponse && tokenResponse.access_token) {
                console.log("Token re√ßu.");
                googleAccessToken = tokenResponse.access_token;
                localStorage.setItem('google_access_token_ldc', googleAccessToken);
                updateAuthUI(true);
                await loadLdcDataFromDrive();
                populateLdcUI(); 
            } else {
                console.error("R√©ponse de token invalide:", tokenResponse);
                let errorMsg = "Erreur d'authentification Google.";
                if (tokenResponse && tokenResponse.error) { errorMsg += ` (${tokenResponse.error})` }
                showMessage(errorMsg, 5000, true);
                googleAccessToken = null;
                updateAuthUI(false);
            }
        }

        function handleAuthClick() {
            if (googleAccessToken) { 
                if (google.accounts && google.accounts.oauth2 && google.accounts.oauth2.revoke) {
                    google.accounts.oauth2.revoke(googleAccessToken, () => {
                        console.log('Token r√©voqu√©.');
                    });
                }
                googleAccessToken = null;
                localStorage.removeItem('google_access_token_ldc');
                updateAuthUI(false);
                ldcDataStore = JSON.parse(JSON.stringify(initialLdcData)); 
                populateLdcUI();
                showMessage("D√©connect√© de Google Drive.", 3000);
            } else { 
                if (tokenClient) {
                    tokenClient.requestAccessToken({ prompt: 'consent' });
                } else {
                    console.error("Client Token non initialis√©.");
                    showMessage("Erreur d'initialisation Google. Veuillez r√©essayer.", 4000, true);
                }
            }
        }
        
        function updateAuthUI(isLoggedIn) {
            const signinButton = document.getElementById('signin-button');
            const driveStatusText = document.getElementById('drive-status-text');
            const driveStatusDiv = document.getElementById('drive-status');

            if (!signinButton || !driveStatusText || !driveStatusDiv) return;

            if (isLoggedIn) {
                signinButton.innerHTML = '<i class="fab fa-google-drive"></i> D√©connexion Drive';
                driveStatusText.textContent = 'Connect√©';
                driveStatusDiv.className = 'drive-status success'; 
            } else {
                signinButton.innerHTML = '<i class="fab fa-google"></i> Connexion Drive';
                driveStatusText.textContent = 'D√©connect√©';
                driveStatusDiv.className = 'drive-status error'; 
            }
            // Bouton de connexion toujours activ√© si le client token est pr√™t ou si d√©j√† connect√© (pour d√©connexion)
            signinButton.disabled = !tokenClient && !isLoggedIn; 
            
            document.getElementById('nouvelle-saison-ldc-btn').disabled = !isLoggedIn;
            document.getElementById('sauvegarde-ldc-btn').disabled = !isLoggedIn;
            const deleteSeasonBtn = document.getElementById('delete-season-ldc-btn');
            if (deleteSeasonBtn) {
                deleteSeasonBtn.disabled = !isLoggedIn || !(ldcDataStore.seasons && ldcDataStore.seasons.length > 1);
            }
        }

        async function findOrCreateFile(filename, defaultContentStr = "{}", mimeType = 'application/json') {
             if (!googleAccessToken) return null;
             const driveStatusText = document.getElementById('drive-status-text');
             const driveStatusDiv = document.getElementById('drive-status');
             if(driveStatusText) driveStatusText.textContent = "Recherche fichier...";
             if(driveStatusDiv) driveStatusDiv.className = 'drive-status loading';

            try {
                const responseSearch = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${filename}'&spaces=drive&fields=files(id,name)`, {
                    headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                });
                if (!responseSearch.ok) throw new Error(`Recherche √©chou√©e: ${responseSearch.status} ${await responseSearch.text()}`);
                const searchResult = await responseSearch.json();

                if (searchResult.files && searchResult.files.length > 0) {
                    if(driveStatusText) driveStatusText.textContent = "Fichier trouv√©.";
                    if(driveStatusDiv) driveStatusDiv.className = 'drive-status success'; 
                    return searchResult.files[0].id;
                } else { /* ... (cr√©ation fichier identique) ... */ }
            } catch (error) { /* ... (gestion erreur identique) ... */ return null; }
             // Assurer que les cas de cr√©ation et d'erreur remettent bien le statut √† 'success' ou 'error'
             // (le code existant semble correct pour cela)
        }
        
        async function readFileContent(fileId) {
            if (!googleAccessToken || !fileId) return null;
            const driveStatusText = document.getElementById('drive-status-text');
            const driveStatusDiv = document.getElementById('drive-status');
            if(driveStatusText) driveStatusText.textContent = "Lecture fichier...";
            if(driveStatusDiv) driveStatusDiv.className = 'drive-status loading';
            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                });
                if (!response.ok) throw new Error(`Lecture √©chou√©e: ${response.status} ${await response.text()}`);
                const content = await response.text();
                if(driveStatusText) driveStatusText.textContent = "Connect√©"; // Ou "Fichier lu."
                if(driveStatusDiv) driveStatusDiv.className = 'drive-status success';
                return content;
            } catch (error) {
                console.error('Erreur Drive (readFileContent):', error);
                showMessage(`Erreur lecture Drive: ${error.message}`, 5000, true);
                if(driveStatusText) driveStatusText.textContent = "Erreur Lecture";
                if(driveStatusDiv) driveStatusDiv.className = 'drive-status error';
                return null;
            }
        }

        async function updateFileContent(fileId, content) {
            if (!googleAccessToken || !fileId || isSavingDriveData) return false;
            isSavingDriveData = true;
            const driveStatusText = document.getElementById('drive-status-text');
            const driveStatusDiv = document.getElementById('drive-status');
            if(driveStatusText) driveStatusText.textContent = "Sauvegarde...";
            if(driveStatusDiv) driveStatusDiv.className = 'drive-status loading';

            try {
                const contentToSave = (typeof content === 'string') ? content : JSON.stringify(content, null, 2);
                const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' },
                    body: contentToSave
                });
                if (!response.ok) throw new Error(`Sauvegarde √©chou√©e: ${response.status} ${await response.text()}`);
                if(driveStatusText) driveStatusText.textContent = "Sauvegard√©!";
                if(driveStatusDiv) driveStatusDiv.className = 'drive-status success';
                setTimeout(() => { 
                    if(driveStatusText && driveStatusText.textContent === "Sauvegard√©!") driveStatusText.textContent = "Connect√©";
                 }, 2000);
                return true;
            } catch (error) {
                console.error('Erreur Drive (updateFileContent):', error);
                showMessage(`Erreur sauvegarde Drive: ${error.message}`, 5000, true);
                 if(driveStatusText) driveStatusText.textContent = "Erreur Sauvegarde";
                 if(driveStatusDiv) driveStatusDiv.className = 'drive-status error';
                return false;
            } finally {
                isSavingDriveData = false;
            }
        }
        
        async function loadLdcDataFromDrive() {
            if (!googleAccessToken) {
                console.log("Non connect√©, utilisation des donn√©es LDC initiales.");
                ldcDataStore = JSON.parse(JSON.stringify(initialLdcData));
                return;
            }
             const driveStatusText = document.getElementById('drive-status-text');
             const driveStatusDiv = document.getElementById('drive-status');
             if(driveStatusText) driveStatusText.textContent = `Chargement ${LDC_DATA_FILENAME}...`;
             if(driveStatusDiv) driveStatusDiv.className = 'drive-status loading';

            let fileId = ldcDataStore.fileId; // Utiliser fileId existant si disponible
            if (!fileId) { // S'il n'y a pas de fileId stock√© (ex: premi√®re ex√©cution)
                 fileId = await findOrCreateFile(LDC_DATA_FILENAME, JSON.stringify(initialLdcData));
            } else { // V√©rifier si le fichier existe toujours, sinon tenter de le recr√©er
                try {
                    const responseSearch = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?fields=id`, {
                         headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                    });
                    if(!responseSearch.ok){ // Si le fichier n'est pas trouv√© ou erreur
                        console.warn(`Fichier avec ID ${fileId} non trouv√© ou inaccessible. Tentative de recr√©ation.`);
                        fileId = await findOrCreateFile(LDC_DATA_FILENAME, JSON.stringify(initialLdcData));
                    }
                } catch (e) {
                    console.error("Erreur v√©rification existence fichier:", e);
                    fileId = await findOrCreateFile(LDC_DATA_FILENAME, JSON.stringify(initialLdcData));
                }
            }
            ldcDataStore.fileId = fileId; // Mettre √† jour le fileId dans le store


            if (ldcDataStore.fileId) {
                const content = await readFileContent(ldcDataStore.fileId);
                if (content && content.trim() !== "") {
                    try {
                        const parsedData = JSON.parse(content);
                        if (parsedData && typeof parsedData.teams === 'object' && Array.isArray(parsedData.seasons)) {
                            ldcDataStore = parsedData;
                            ldcDataStore.fileId = fileId; 
                            ldcDataStore.filename = LDC_DATA_FILENAME;
                            console.log(`Donn√©es LDC charg√©es depuis Drive.`);
                             if(driveStatusText) driveStatusText.textContent = 'Connect√©';
                             if(driveStatusDiv) driveStatusDiv.className = 'drive-status success';
                        } else {
                            console.warn(`Donn√©es LDC malform√©es sur Drive. Utilisation des donn√©es initiales.`);
                            ldcDataStore = JSON.parse(JSON.stringify(initialLdcData));
                            ldcDataStore.fileId = fileId; ldcDataStore.filename = LDC_DATA_FILENAME;
                            await saveLdcDataToDrive(true); // Sauvegarder les donn√©es initiales propres
                        }
                    } catch (e) {
                        console.error(`Erreur parsing LDC Drive:`, e); showMessage(`Donn√©es LDC Drive corrompues. Utilisation des donn√©es initiales.`, 7000, true);
                        ldcDataStore = JSON.parse(JSON.stringify(initialLdcData));
                        ldcDataStore.fileId = fileId; ldcDataStore.filename = LDC_DATA_FILENAME;
                        await saveLdcDataToDrive(true);
                    }
                } else {
                     console.log(`Fichier LDC vide sur Drive. Initialisation avec structure par d√©faut.`);
                     ldcDataStore = JSON.parse(JSON.stringify(initialLdcData));
                     ldcDataStore.fileId = fileId; ldcDataStore.filename = LDC_DATA_FILENAME;
                     await saveLdcDataToDrive(true); 
                }
            } else {
                console.warn(`Impossible trouver/cr√©er fichier LDC sur Drive. Utilisation des donn√©es initiales.`);
                showMessage(`Fichier LDC Drive inaccessible.`, 7000, true);
                ldcDataStore = JSON.parse(JSON.stringify(initialLdcData));
                ldcDataStore.filename = LDC_DATA_FILENAME; // Garder le nom de fichier m√™me si pas de fileId
                 if(driveStatusText) driveStatusText.textContent = 'Erreur Fichier';
                 if(driveStatusDiv) driveStatusDiv.className = 'drive-status error';
            }
        }
        
        async function saveLdcDataToDrive(isInitialSave = false) {
            if (!googleAccessToken) { if(!isInitialSave) showMessage("Connectez-vous pour sauvegarder LDC.", 3000, true); return; }
            if (!ldcDataStore || !ldcDataStore.filename) { console.error(`Donn√©es LDC ou nom de fichier manquant.`); return; }
            if (!ldcDataStore.fileId) {
                ldcDataStore.fileId = await findOrCreateFile(ldcDataStore.filename, JSON.stringify(ldcDataStore));
                if(!ldcDataStore.fileId){ showMessage(`Impossible de cr√©er/trouver le fichier LDC sur Drive.`, 5000, true); return; }
            }
            console.log(`Sauvegarde LDC sur Drive (File ID: ${ldcDataStore.fileId}).`);
            const success = await updateFileContent(ldcDataStore.fileId, ldcDataStore);
            if (success) { if(!isInitialSave) showMessage(`Donn√©es LDC sauvegard√©es !`, 2000); }
            else { if(!isInitialSave) showMessage(`√âchec sauvegarde LDC sur Drive.`, 3000, true); }
        }

        function populateLdcSeasonSelector() { /* ... (Identique) ... */ }
        function populateLdcTeamsGridDOM(teamsData) { /* ... (Identique) ... */ }
        
        function generateKnockoutStage(stageName, numExpectedMatches, teamsAvailable, previousStageWinners = null) { /* ... (Identique) ... */ }

        function createNewLdcSeason() { /* ... (Identique) ... */ }
        function deleteSelectedLdcSeason() { /* ... (Identique) ... */ }
        function handleLdcSeasonChange(event) { /* ... (Identique) ... */ }

        function populateLdcFixturesDOM(activeSeason) { /* ... (Identique - voir version pr√©c√©dente pour le code du bracket visuel) ... */ }
        function handleLdcScoreChange(event) { /* ... (Identique - voir version pr√©c√©dente) ... */ }
        function checkAndAdvanceLdcStage(activeSeason) { /* ... (Identique - voir version pr√©c√©dente) ... */ }
        function displayLdcWinner(activeSeason) { /* ... (Identique) ... */ }
        
        function populateLdcUI() {
            populateLdcSeasonSelector();
            const activeSeason = ldcDataStore.seasons.find(s => s.season_id === ldcDataStore.active_season_id);
            populateLdcTeamsGridDOM(ldcDataStore.teams); 
            if (activeSeason) {
                if (!activeSeason.phase_elimination) activeSeason.phase_elimination = { huitiemes: [], quarts: [], demies: [], finale: [] };
                ['huitiemes', 'quarts', 'demies', 'finale'].forEach(phase => {
                    if (!activeSeason.phase_elimination[phase]) activeSeason.phase_elimination[phase] = [];
                });
                checkAndAdvanceLdcStage(activeSeason); 
                displayLdcWinner(activeSeason);
            } else {
                const bracketContainer = document.getElementById('ldc-knockout-stages');
                if (bracketContainer) bracketContainer.innerHTML = '<p style="text-align:center; padding:20px; color: var(--current-text-light);">Aucune saison LDC active. Cr√©ez une nouvelle saison pour commencer.</p>';
                const winnerSection = document.getElementById('ldc-winner-section');
                if (winnerSection) winnerSection.style.display = 'none';
            }
            const deleteBtn = document.getElementById(`delete-season-ldc-btn`);
            if(deleteBtn) deleteBtn.disabled = !googleAccessToken || !ldcDataStore.seasons || ldcDataStore.seasons.length <= 1;
            
            const saveBtn = document.getElementById('sauvegarde-ldc-btn');
            if(saveBtn) saveBtn.disabled = !googleAccessToken;
            const newSeasonBtn = document.getElementById('nouvelle-saison-ldc-btn');
            if(newSeasonBtn) newSeasonBtn.disabled = !googleAccessToken;
        }
        
        // --- INITIALISATION ET √âCOUTEURS D'√âV√âNEMENTS ---
        document.addEventListener('DOMContentLoaded', async () => {
            messageArea = document.getElementById('message-area');
            ldcAudioPlayer = document.getElementById('ldc-audio-player'); 
            
            // Attachement des √©couteurs d'√©v√©nements ici
            document.getElementById('nouvelle-saison-ldc-btn')?.addEventListener('click', createNewLdcSeason);
            document.getElementById('sauvegarde-ldc-btn')?.addEventListener('click', () => saveLdcDataToDrive());
            document.getElementById('delete-season-ldc-btn')?.addEventListener('click', deleteSelectedLdcSeason);
            document.getElementById('ldc-season-selector')?.addEventListener('change', handleLdcSeasonChange);
            document.getElementById('signin-button')?.addEventListener('click', handleAuthClick);

            const hamburger = document.querySelector('.hamburger'); 
            const nav = document.querySelector('header nav');
            if (hamburger && nav) {
                hamburger.addEventListener('click', () => { 
                    nav.classList.toggle('active'); 
                    const icon = hamburger.querySelector('i'); 
                    icon.classList.toggle('fa-bars'); 
                    icon.classList.toggle('fa-times'); 
                });
                document.addEventListener('click', (e) => { 
                    const target = e.target; 
                    const isClickInsideNav = nav.contains(target) || hamburger.contains(target); 
                    if (!isClickInsideNav && nav.classList.contains('active')) { 
                        nav.classList.remove('active'); 
                        hamburger.querySelector('i').className = 'fas fa-bars'; 
                    } 
                });
            }

            const allNavLinks = document.querySelectorAll('header nav ul li a');
            allNavLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 992 && nav && nav.classList.contains('active')) { 
                        nav.classList.remove('active'); 
                        if(hamburger) hamburger.querySelector('i').className = 'fas fa-bars'; 
                    }
                    allNavLinks.forEach(l => l.classList.remove('active-nav-link'));
                    link.classList.add('active-nav-link');
                });
            });
        
            const ldcMusicBtn = document.getElementById('ldc-music-btn');
            if (ldcMusicBtn && ldcAudioPlayer) { 
                ldcMusicBtn.addEventListener('click', () => {
                    initAudioContext(); 
                    const icon = ldcMusicBtn.querySelector('i');
                    if (ldcAudioPlayer.paused || ldcAudioPlayer.ended) {
                        ldcAudioPlayer.play().catch(e => {
                            console.warn("Erreur lecture auto audio LDC:", e);
                            showMessage("Cliquez √† nouveau pour jouer l'hymne.", 2000);
                        });
                        icon.classList.remove('fa-play'); icon.classList.add('fa-pause');
                    } else {
                        ldcAudioPlayer.pause();
                        icon.classList.remove('fa-pause'); icon.classList.add('fa-play');
                    }
                });
            }
            
            // Initialisation Google Drive et chargement des donn√©es
            const storedToken = localStorage.getItem('google_access_token_ldc');
            if (storedToken) {
                googleAccessToken = storedToken;
                console.log("Token r√©cup√©r√© du localStorage.");
            }
            
            await checkAndInitGis(); 

            if(googleAccessToken){ 
                updateAuthUI(true); 
                await loadLdcDataFromDrive(); 
            } else {
                updateAuthUI(false); 
                ldcDataStore = JSON.parse(JSON.stringify(initialLdcData));
            }
            
            populateLdcUI(); 
            
            const observer = new IntersectionObserver((entries, obs) => { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.style.opacity = '1'; entry.target.style.transform = 'translateY(0)'; obs.unobserve(entry.target); } }); }, { threshold: 0.05 }); 
            document.querySelectorAll('.section').forEach(el => { 
                if (el.style.opacity !== '1') { el.style.opacity = '0'; el.style.transform = 'translateY(25px)'; } 
                observer.observe(el);
            });
            
            const activeNavLink = document.querySelector('header nav ul li a[href="champions.html"]');
            if(activeNavLink) activeNavLink.classList.add('active-nav-link');

            console.log("Page LDC initialis√©e. Erreurs JS principales corrig√©es.");
        });

    </script>
</body>
</html>
